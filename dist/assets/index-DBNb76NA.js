import{getFirestore as ti,doc as Nt,getDoc as ni,deleteDoc as ii,setDoc as ai,collection as Zt,onSnapshot as Xt}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{initializeApp as oi}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as si,onAuthStateChanged as ri,signOut as li,signInWithEmailAndPassword as ci,EmailAuthProvider as di,linkWithCredential as mi,createUserWithEmailAndPassword as ui,signInAnonymously as gi}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function i(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(a){if(a.ep)return;a.ep=!0;const o=i(a);fetch(a.href,o)}})();let Ne=0,vt=0;const ie=document.body;function pi(){vt=window.scrollY,ie.style.position="fixed",ie.style.top=`-${vt}px`,ie.style.width="100%"}function hi(){ie.style.position="",ie.style.top="",ie.style.width="",window.scrollTo(0,vt)}function Je(){Ne===0&&pi(),Ne++}function Qe(){Ne--,Ne===0&&hi()}const fi={apiKey:void 0,authDomain:void 0,projectId:void 0,storageBucket:void 0,messagingSenderId:void 0,appId:void 0,measurementId:void 0},Sn=oi(fi),P=si(Sn),Ee=ti(Sn),vi=["510WsOiCBmdTYStLx14ZBvaikro1"];let K={isPro:!1,plan:null,endDate:null};async function en(e){if(e&&vi.includes(e)){console.log("👑 Admin kullanıcı algılandı. Tüm özellikler açılıyor."),K={isPro:!0,plan:"admin",endDate:null};return}if(!e){K={isPro:!1,plan:null,endDate:null};return}const t=Nt(Ee,"users",e),i=await ni(t);if(i.exists()&&i.data().subscription){const n=i.data().subscription,a=n.endDate&&new Date(n.endDate.toMillis())>new Date;n.isPro&&a?K={isPro:!0,plan:n.plan||null,endDate:n.endDate.toDate()}:K={isPro:!1,plan:null,endDate:null}}else K={isPro:!1,plan:null,endDate:null};console.log("User subscription status updated:",K)}function je(){return K.isPro}function yt(){const e=document.querySelectorAll(".pro-feature"),t=je();e.forEach(i=>{t?i.classList.remove("feature-locked"):i.classList.add("feature-locked")})}let B,tn,it,nn,Se="yearly";function yi(){B=document.getElementById("paywall-overlay"),B&&(tn=document.getElementById("close-paywall-btn"),it=document.getElementById("plan-selector"),nn=document.getElementById("upgrade-to-pro-btn"),tn.addEventListener("click",an),B.addEventListener("click",e=>{e.target===B&&an()}),it.addEventListener("click",e=>{const t=e.target.closest(".plan-option");t&&(it.querySelectorAll(".plan-option").forEach(i=>i.classList.remove("recommended")),t.classList.add("recommended"),Se=t.dataset.plan,console.log(`Selected plan: ${Se}`))}),nn.addEventListener("click",()=>{console.log(`Satın alma işlemi başlatıldı: ${Se}`),alert(`"${Se}" planı için satın alma işlemi başlatılıyor... (Bu henüz gerçek bir ödeme değil)`)}))}function _t(){B&&(B.classList.remove("hidden"),setTimeout(()=>B.classList.add("visible"),10))}function an(){B&&(B.classList.remove("visible"),B.addEventListener("transitionend",()=>{B.classList.contains("visible")||B.classList.add("hidden")},{once:!0}))}let J={},Cn="tr";async function jt(e){try{const t=await fetch(`/locales/${e}.json`);if(!t.ok)throw new Error("Dil dosyası yüklenemedi.");J=await t.json(),Cn=e,_i(),localStorage.setItem("preferredLanguage",e),console.log(`Dil ${e} olarak ayarlandı.`),document.dispatchEvent(new CustomEvent("language-changed"))}catch(t){console.error(`Dil yüklenirken hata oluştu: ${e}`,t),e!=="tr"&&await jt("tr")}}function _i(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.dataset.i18n;if(J[t]){const i=e.firstChild;i&&i.nodeType===Node.TEXT_NODE?i.nodeValue=J[t]:e.textContent=J[t]}}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.dataset.i18nPlaceholder;J[t]&&(e.placeholder=J[t])})}function s(e){return J[e]||e}function V(){return Cn}function bi(){const e=localStorage.getItem("preferredLanguage"),t=navigator.language.split("-")[0],i=e||(["en","tr"].includes(t)?t:"tr");jt(i)}let te,at,ot,he,fe;function wi(){if(te=document.getElementById("settings-overlay"),document.getElementById("settings-panel"),at=document.getElementById("settings-icon-btn"),ot=document.getElementById("settings-close-btn"),he=document.getElementById("lang-tr-btn"),fe=document.getElementById("lang-en-btn"),!te||!at||!ot||!he||!fe){console.error("Ayarlar menüsü için gerekli HTML elemanları bulunamadı.");return}at.addEventListener("click",Ei),te.addEventListener("click",e=>{e.target===te&&bt()}),ot.addEventListener("click",bt),he.addEventListener("click",()=>on("tr")),fe.addEventListener("click",()=>on("en"))}function Ei(){V()==="tr"?(he.classList.add("active"),fe.classList.remove("active")):(fe.classList.add("active"),he.classList.remove("active")),te.classList.add("visible")}function bt(){te.classList.remove("visible")}function on(e){jt(e),bt()}function Li(e){ri(P,e)}function Ii(){return gi(P)}async function ki(e,t){const i=P.currentUser;if(i&&i.isAnonymous){const n=di.credential(e,t);return mi(i,n)}return ui(P,e,t)}function Bi(e,t){return ci(P,e,t)}function Mi(){return li(P)}console.log("utils.js yüklendi.");const xi="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.921-7.417 3.921 1.481-8.279-6.064-5.828 8.332-1.151z",wt="halfStarGradient";function Ai(e){if(!e)return"";const t=new Date(e),i=new Date,n=new Date(i);if(n.setDate(i.getDate()-1),t.toDateString()===i.toDateString())return s("date_today");if(t.toDateString()===n.toDateString())return s("date_yesterday");{const a=V()==="tr"?"tr-TR":"en-US",o={year:"numeric",month:"long",day:"numeric"},l=t.toLocaleDateString(a,o);return s("date_on_date").replace("{date}",l)}}function z(e,t="info",i=4e3){const n=document.getElementById("notification-container");if(!n){console.error("Notification container not found!");return}const a=document.createElement("div");a.className=`notification ${t}`,a.textContent=e,n.appendChild(a),setTimeout(()=>{a.classList.add("fade-out"),a.addEventListener("animationend",()=>{a.remove()})},i)}console.log("api.js yüklendi.");const ae="/api/tmdb",Dn="https://image.tmdb.org/t/p/w500",Ze="https://image.tmdb.org/t/p/w185",Ue="https://image.tmdb.org/t/p/w92",Si="https://www.youtube-nocookie.com/embed/";async function Ci(){try{const t=V()==="tr"?"tr-TR":"en-US",i=`${ae}/trending/movie/week?language=${t}`,n=await fetch(i);if(!n.ok)throw new Error(`Proxy Hatası! Durum: ${n.status}`);const a=await n.json();return a.results?a.results.slice(0,10):[]}catch(e){throw console.error("Trend filmler yüklenirken hata oluştu:",e),e}}async function Xe(e){try{const i=V()==="tr"?"tr-TR":"en-US",n=`${ae}/movie/${e}?language=${i}`,a=`${ae}/movie/${e}/credits?language=${i}`,o=`${ae}/movie/${e}/videos?language=en-US`,l=await fetch(n);if(!l.ok)throw new Error(`Film detayları proxy'den yüklenemedi. HTTP Hata: ${l.status}`);const r=await l.json(),d=await fetch(a);let p="Bilinmiyor",f=[];if(d.ok){const h=await d.json(),g=h.crew.find(v=>v.job==="Director");g&&(p=g.name),f=h.cast.filter(v=>v.known_for_department==="Acting"&&v.profile_path).sort((v,L)=>v.order-L.order).slice(0,10)}else console.warn("Yönetmen/oyuncu bilgisi yüklenemedi. HTTP Hata:",d.status);const c=await fetch(o);let m=null;if(c.ok){const g=(await c.json()).results.find(v=>v.site==="YouTube"&&v.type==="Trailer"&&v.key);g&&(m=g.key)}else console.warn("Film videoları yüklenemedi. HTTP Hata:",c.status);return{movieData:r,directorName:p,cast:f,trailerKey:m}}catch(t){throw console.error("fetchMovieDetailsFromApi Hatası:",t),t}}async function Di(e,t,i,n){if(e.length<2){i.textContent="En az 2 karakter giriniz.",i.style.display="block",t.classList.add("hidden"),t.innerHTML="";return}t.innerHTML="",i.style.display="none";try{const o=V()==="tr"?"tr-TR":"en-US",l=`${ae}/search/movie?query=${encodeURIComponent(e)}&language=${o}`,r=await fetch(l);if(!r.ok)throw new Error(`Proxy Hatası! Durum: ${r.status}`);const d=await r.json();d.results&&d.results.length>0?n(d.results,t):(i.textContent="Film bulunamadı.",i.style.display="block",t.classList.add("hidden"))}catch(a){console.error("TMDB arama sırasında proxy hatası oluştu:",a),i.innerHTML=`
            <p class="text-red-400 font-bold text-base">Arama Hatası!</p>
            <p class="mt-1 text-sm text-gray-400">Film ararken bir sorun oluştu: ${a.message}.</p>
        `,i.style.display="block"}}async function Tn(e){const{type:t,tmdbId:i}=e;try{let n=[];switch(t){case"list":case"collection":case"endpoint":case"director":{let a="";t==="list"?a=`/list/${i}`:t==="collection"?a=`/collection/${i}`:t==="director"?a=`/person/${i}/movie_credits`:a=String(i);const o=a.includes("?")?"&":"?",r=V()==="tr"?"tr-TR":"en-US",d=`${ae}${a}${o}language=${r}`,p=await fetch(d);if(!p.ok)throw new Error(`HTTP Hatası! Durum: ${p.status}`);const f=await p.json();t==="director"?n=f.crew.filter(c=>c.job==="Director").sort((c,m)=>new Date(m.release_date)-new Date(c.release_date)):n=f.results||f.parts||f.items||[];break}case"manual":{const a=i.map(l=>Xe(l));n=(await Promise.all(a)).map(l=>l.movieData);break}default:throw new Error("Geçersiz liste tipi")}return n}catch(n){return console.error(`'${e.name}' listesi filmleri çekilirken hata oluştu:`,n),[]}}async function Ti(e,t=!1){try{const i=await fetch("/api/suggest-movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,isRetry:t,lang:V()})});if(!i.ok){const n=await i.text();try{const a=JSON.parse(n);throw new Error(a.error||`Film önerisi alınırken bir hata oluştu: ${i.status}`)}catch{throw new Error(`Sunucu fonksiyonu bulunamadı veya bir hata oluştu (HTTP ${i.status}).`)}}return await i.json()}catch(i){throw console.error("fetchSuggestedMovie hatası:",i),i}}console.log("rating.js yüklendi.");let _=0;function Et(e,t=0){console.log("setupStarRating çağrıldı, başlangıç puanı:",t),e.innerHTML="",_=t;for(let i=1;i<=5;i++){const n=document.createElement("span");n.classList.add("star-container"),n.dataset.value=i,n.innerHTML=`
            <svg class="star-svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="${xi}"/>
            </svg>
        `,e.appendChild(n),n.addEventListener("mousemove",a=>{const o=n.getBoundingClientRect(),l=a.clientX-o.left,r=parseFloat(n.dataset.value);l<o.width/2?Ce(e,r-.5):Ce(e,r)}),n.addEventListener("mouseleave",()=>{Ce(e,_)}),n.addEventListener("click",a=>{const o=parseFloat(n.dataset.value);let l;const r=n.getBoundingClientRect();a.clientX-r.left<r.width/2?l=o-.5:l=o,_===l?_===o?_=o-.5:_===o-.5&&(_=o):_=l,_<0&&(_=0),console.log("Yeni puan:",_),sn(e,_),Ce(e,_)})}sn(e,_)}function sn(e,t){e.querySelectorAll(".star-container").forEach(n=>{const a=parseFloat(n.dataset.value),o=n.querySelector("path");n.classList.remove("selected","selected-half"),t>=a?(n.classList.add("selected"),o.setAttribute("fill","#FFD700")):t===a-.5?(n.classList.add("selected-half"),o.setAttribute("fill",`url(#${wt})`)):o.setAttribute("fill","#666666")})}function Ce(e,t){e.querySelectorAll(".star-container").forEach(n=>{const a=parseFloat(n.dataset.value),o=n.querySelector("path");n.classList.remove("hovered","hovered-half"),t>=a?(n.classList.add("hovered"),o.setAttribute("fill","#FFD700")):t===a-.5?(n.classList.add("hovered-half"),o.setAttribute("fill",`url(#${wt})`)):_>=a?o.setAttribute("fill","#FFD700"):_===a-.5?o.setAttribute("fill",`url(#${wt})`):o.setAttribute("fill","#666666")})}function st(e){_=e}async function $n(e,t){try{const i=await fetch(`/api/gemini${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),n=await i.json();if(!i.ok){const a=n.error?.message||`Proxy hatası: ${i.status}`;throw new Error(a)}return n}catch(i){throw console.error(`Gemini API çağrısı sırasında hata (${e}):`,i),i}}async function $i(e,t,i,n){n.classList.add("loading"),n.disabled=!0;try{const o={contents:[{role:"user",parts:[{text:s("gemini_prompt_enhance").replace("{movieTitle}",t).replace("{comment}",e)}]}]},l=await $n("/gemini-1.5-flash-latest:generateContent",o);if(l.candidates?.[0]?.content?.parts?.[0]?.text)i.value=l.candidates[0].content.parts[0].text,z(s("notification_comment_enhanced"),"success");else throw new Error(s("gemini_error_unexpected_response"))}catch(a){z(s("notification_comment_enhance_fail").replace("{error}",a.message),"error")}finally{n.classList.remove("loading"),n.disabled=!1}}async function Pi(e,t,i,n){const a=s("gemini_prompt_chat_system").replace("{movieTitle}",t).replace("{characterName}",e),o=[];o.push({role:"user",parts:[{text:a}]}),o.push({role:"model",parts:[{text:s("gemini_prompt_chat_ack").replace("{characterName}",e)}]}),i.forEach(d=>o.push({role:d.role,parts:[{text:d.text}]})),o.push({role:"user",parts:[{text:n}]});const r=await $n("/gemini-1.5-flash-latest:generateContent",{contents:o});if(r.candidates?.[0]?.content?.parts?.[0]?.text)return r.candidates[0].content.parts[0].text;if(r.promptFeedback?.blockReason)return s("gemini_error_blocked").replace("{reason}",r.promptFeedback.blockReason);throw new Error(s("gemini_error_no_response"))}let q,rt,R,X,G,lt,Pn,Rn,ve,ct,ye,Lt,Ut={tmdbId:null,title:null},W=null,ne=[];const rn=10;let ln=!1;function Fn(){ln||(q=document.getElementById("character-selection-modal"),rt=document.getElementById("close-character-selection-modal-btn"),R=document.getElementById("character-list-container"),X=document.getElementById("character-list-loader"),G=document.getElementById("chat-interface-modal"),lt=document.getElementById("close-chat-interface-modal-btn"),Pn=document.getElementById("chat-header-character-avatar"),Rn=document.getElementById("chat-header-character-name"),ve=document.getElementById("chat-messages-container"),ct=document.getElementById("chat-form"),ye=document.getElementById("chat-message-input"),Lt=document.getElementById("chat-send-btn"),rt&&rt.addEventListener("click",It),q&&q.addEventListener("click",e=>{e.target===q&&It()}),lt&&lt.addEventListener("click",cn),G&&G.addEventListener("click",e=>{e.target===G&&cn()}),ct&&ct.addEventListener("submit",ji),ln=!0)}function Ri(e){if(R.replaceChildren(),!e||e.length===0){const t=document.createElement("p");t.className="text-center text-gray-500",t.textContent=s("character_no_character_found"),R.appendChild(t);return}e.forEach(t=>{const i=document.createElement("div");i.className="character-item";const n=document.createElement("img");n.className="character-avatar",n.alt=t.name,n.src=t.profile_path?`${Ze}${t.profile_path}`:"https://placehold.co/60x60/2d333b/8b949e?text=?",n.addEventListener("error",()=>{n.src="https://placehold.co/60x60/2d333b/8b949e?text=?"},{once:!0});const a=document.createElement("div");a.className="character-info";const o=document.createElement("div");o.className="character-name",o.textContent=t.character||t.name;const l=document.createElement("div");l.className="character-actor",l.textContent=t.name,a.append(o,l),i.append(n,a),i.addEventListener("click",()=>Hi(t)),R.appendChild(i)})}function Fi(){Fn();const e=document.getElementById("movie-tmdb-id").value,t=document.getElementById("movie-title-input").value;if(!e){z("Sohbet için filmin TMDB verisi gerekli.","error");return}Oi({id:e,title:t})}async function Oi(e){Ut=e,q.classList.remove("hidden"),setTimeout(()=>q.classList.add("visible"),10),document.body.classList.add("no-scroll"),R.classList.add("hidden"),X.classList.remove("hidden"),X.classList.add("visible");const t=X.querySelector("dotlottie-player");t&&t.play();try{const{cast:i}=await Xe(e.id),n=i.filter(a=>a.known_for_department==="Acting"&&a.profile_path).sort((a,o)=>a.order-o.order).slice(0,10);Ri(n),R.classList.remove("hidden")}catch(i){console.error("Karakterler alınırken hata:",i),R.replaceChildren();const n=document.createElement("p");n.className="text-red-400 text-center",n.textContent=s("character_loading_error"),R.appendChild(n),R.classList.remove("hidden")}finally{t&&t.stop(),X.classList.add("hidden"),X.classList.remove("visible")}}function It(){q.classList.remove("visible"),G.classList.contains("visible")||document.body.classList.remove("no-scroll")}function Hi(e){W=e,It(),Ni()}function Ni(){ne=[],ve.innerHTML="",ye.value="";const e=W.character||W.name;Rn.textContent=e,Pn.src=W.profile_path?Ze+W.profile_path:"https://placehold.co/60x60/2A2A2A/AAAAAA?text=?",G.classList.remove("hidden"),setTimeout(()=>G.classList.add("visible"),10),document.body.classList.add("no-scroll");const t=s("chat_welcome").replace("{characterName}",e);kt("model",t)}function cn(){G.classList.remove("visible"),q.classList.contains("visible")||document.body.classList.remove("no-scroll"),W=null,Ut={tmdbId:null,title:null}}async function ji(e){e.preventDefault();const t=ye.value.trim();if(!t)return;kt("user",t),dn({role:"user",text:t}),ye.value="";const i=kt("model","",!0);Lt.disabled=!0;try{const n=await Pi(W.character||W.name,Ut.title,ne,t);i.innerHTML=n,i.classList.remove("thinking"),dn({role:"model",text:n})}catch(n){i.innerHTML=s("chat_error_generic").replace("{error}",n.message),i.classList.remove("thinking")}finally{Lt.disabled=!1,ye.focus()}}function kt(e,t,i=!1){const n=document.createElement("div");n.className=`chat-message ${e}`;const a=document.createElement("div");return a.className="message-bubble",i?(a.classList.add("thinking"),a.innerHTML="<span></span><span></span><span></span>"):a.textContent=t,n.appendChild(a),ve.appendChild(n),ve.scrollTop=ve.scrollHeight,a}function dn(e){ne.push(e),ne.length>rn&&ne.splice(0,ne.length-rn)}let S,Bt,oe,se,Le,C,qe,Y,F,re,E,_e,j,Q,Ge,Mt,We,Ye,ze,A,De,dt,Te,mn,un,gn,pn,mt,ut,Pe,H,xt,hn=!1;function Ui(){if(hn)return;const e=document.getElementById("movie-modal-overlay");if(!e)return;const t=document.createElement("div");t.className="modal-content",t.innerHTML=`
      <div class="modal-header"><h2 id="modal-title"></h2></div>
      <form id="movie-form" novalidate>
          <input type="hidden" id="movie-id" /><input type="hidden" id="movie-tmdb-id" /><input type="hidden" id="movie-type" /><input type="hidden" id="movie-runtime-input" /><input type="hidden" id="movie-genres-input" /><input type="hidden" id="movie-director-input" />
          <div class="form-group">
              <label for="movie-title-input">${s("modal_movie_title_label")}</label>
              <input type="text" id="movie-title-input" required placeholder="${s("placeholder_movie_title")}" />
              <div id="tmdb-search-results" class="tmdb-search-results hidden"></div>
              <p id="tmdb-search-message" class="tmdb-search-message" style="display: none;"></p>
          </div>
          <input type="hidden" id="movie-poster-input" />
          <div class="form-group"><label for="movie-rating-input">${s("modal_rating_label")}</label><div id="movie-rating-input" class="rating-input"></div></div>
          <label class="toggle-switch-container"><span class="toggle-switch-label">${s("modal_watch_later_label")}</span><div class="toggle-switch-wrapper"><input type="checkbox" id="watch-later-checkbox" /><span class="toggle-switch-slider"></span></div></label>
          <div class="form-group" id="watched-date-group"><label for="movie-date-input">${s("modal_watched_date_label")}</label><input type="date" id="movie-date-input" value="" required /></div>
          <div class="form-group">
              <label for="movie-comment-input">${s("modal_comment_label")}</label>
              <textarea id="movie-comment-input" rows="3" placeholder="${s("ai_prompt_modal_placeholder")}"></textarea>
              <div class="form-buttons-group">
                  <button type="button" id="enhance-comment-button" class="enhance-comment-button pro-feature"><span class="loading-spinner"></span><span class="button-text">${s("modal_enhance_comment_button")}<span class="pro-badge">PRO</span></span></button>
                  <button type="button" id="chat-with-character-button" class="chat-character-button hidden pro-feature"><span class="loading-spinner"></span><span class="button-text">${s("modal_chat_button")}<span class="pro-badge">PRO</span></span></button>
              </div>
          </div>
          <div class="modal-actions">
              <button type="button" id="cancel-button" class="cancel-button">${s("modal_cancel_button")}</button>
              <button type="submit" id="save-button" class="save-button">${s("modal_save_button")}</button>
          </div>
      </form>
  `,e.appendChild(t),S=e,Bt=document.getElementById("modal-title"),oe=document.getElementById("movie-id"),se=document.getElementById("movie-tmdb-id"),Le=document.getElementById("movie-type"),C=document.getElementById("movie-title-input"),qe=document.getElementById("movie-poster-input"),Y=document.getElementById("movie-rating-input"),F=document.getElementById("watch-later-checkbox"),re=document.getElementById("watched-date-group"),E=document.getElementById("movie-date-input"),_e=document.getElementById("movie-comment-input"),j=document.getElementById("enhance-comment-button"),Q=document.getElementById("chat-with-character-button"),Ge=document.getElementById("tmdb-search-results"),Mt=document.getElementById("tmdb-search-message"),We=document.getElementById("movie-runtime-input"),Ye=document.getElementById("movie-genres-input"),ze=document.getElementById("movie-director-input"),xt=document.getElementById("movie-form"),xt.addEventListener("submit",qi),document.getElementById("cancel-button").addEventListener("click",()=>At()),S.addEventListener("click",n=>{n.target===S&&At()});let i;F.addEventListener("change",()=>{const n=Y.parentElement,a=!!se.value;F.checked?(E.disabled=!0,E.required=!1,re.style.display="none",n.style.display="none",Y.innerHTML="",j.style.display="none",Q.classList.add("hidden")):(E.disabled=!1,E.required=!0,re.style.display="block",n.style.display="block",Et(Y,0),j.style.display="block",a&&Q.classList.remove("hidden"))}),C.addEventListener("input",()=>{C.readOnly||(clearTimeout(i),i=setTimeout(()=>{Di(C.value,Ge,Mt,Zi)},300))}),j.addEventListener("click",async()=>{if(!je()){_t();return}const n=_e.value.trim();if(n.length<10){z(s("notification_save_validation_fail"),"error");return}await $i(n,C.value,_e,j)}),Q.addEventListener("click",()=>{if(!je()){_t();return}Fi()}),hn=!0}function Me(e=null,t=null,i=null){Je(),Ui();const n=new Date().toISOString().split("T")[0];E.max=n,xt.reset(),st(0),Ge.innerHTML="",Ge.classList.add("hidden"),Mt.style.display="none",C.readOnly=!1,Q.classList.add("hidden");const a=Y.parentElement;if(e){let r,d=i==="watch-later";d?r=xe.find(p=>p.id===e):r=ce.find(p=>p.id===e),r&&(Bt.textContent=s("modal_edit_title"),oe.value=r.id,se.value=r.tmdbId||"",Le.value=i,We.value=r.runtime||"",C.value=r.title,qe.value=r.poster,_e.value=r.comment||"",Ye.value=JSON.stringify(r.genres||[]),ze.value=r.director||"",F.checked=d,d?(E.disabled=!0,E.required=!1,re.style.display="none",a.style.display="none",j.style.display="none",st(0),Y.innerHTML=""):(E.disabled=!1,E.required=!0,re.style.display="block",a.style.display="block",j.style.display="block",E.value=r.watchedDate||"",st(r.rating||0),Et(Y,r.rating||0)))}else Bt.textContent=s("modal_add_title"),oe.value="",Le.value="watched",E.value=n,F.checked=!1,E.disabled=!1,E.required=!0,re.style.display="block",a.style.display="block",j.style.display="block",Et(Y,0),t&&(C.value=t.title||"",qe.value=t.poster||"",We.value=t.runtime||"",Ye.value=JSON.stringify(t.genres||[]),ze.value=t.director||"",se.value=t.tmdbId||"",t.release_date&&(E.value=t.release_date),C.readOnly=!0);const o=!!se.value,l=F.checked;o&&!l?Q.classList.remove("hidden"):Q.classList.add("hidden"),yt(),S.classList.remove("hidden"),setTimeout(()=>S.classList.add("visible"),10)}function At(){S&&(Qe(),S.classList.remove("visible"),S.addEventListener("transitionend",()=>{S.classList.contains("visible")||S.classList.add("hidden")},{once:!0}))}async function qt(e,t=!1){Je(),A||(A=document.getElementById("movie-details-modal-overlay"),De=document.getElementById("detail-modal-title"),dt=document.getElementById("detail-modal-body"),Te=document.getElementById("detail-lottie-loader"),mn=document.getElementById("detail-movie-poster"),un=document.getElementById("detail-movie-release-date"),gn=document.getElementById("detail-movie-genres"),pn=document.getElementById("detail-movie-director"),mt=document.getElementById("detail-movie-overview"),ut=document.getElementById("detail-movie-trailer-section"),Pe=document.getElementById("detail-movie-trailer-iframe"),H=document.getElementById("detail-add-to-log-button")),t&&A.classList.add("is-layered"),A.classList.remove("hidden"),setTimeout(()=>A.classList.add("visible"),10),dt.style.display="none",Te.style.display="flex";const i=Te.querySelector("dotlottie-player");i&&i.play(),De.textContent=s("loading"),H.disabled=!0;const n=new Promise(o=>setTimeout(o,500)),a=Xe(e);try{const[o,l]=await Promise.all([n,a]),{movieData:r,directorName:d,trailerKey:p}=l;De.textContent=r.title||s("details_no_info"),mn.src=r.poster_path?`${Dn}${r.poster_path}`:"https://placehold.co/112x160/2A2A2A/AAAAAA?text=Poster+Yok",un.textContent=`${s("details_release_date_prefix")}: ${r.release_date?new Date(r.release_date).toLocaleDateString(V()==="tr"?"tr-TR":"en-US",{year:"numeric",month:"long",day:"numeric"}):s("details_no_info")}`,gn.textContent=`${s("details_genres_prefix")}: ${r.genres?.length>0?r.genres.map(g=>g.name).join(", "):s("details_no_info")}`,pn.textContent=`${s("details_director_prefix")}: ${d}`,mt.textContent=r.overview||s("details_no_overview");const f=document.getElementById("detail-tmdb-rating"),c=document.getElementById("detail-imdb-link"),m=document.getElementById("detail-ratings-container");r.vote_average?f.textContent=r.vote_average.toFixed(1):f.textContent="N/A",r.imdb_id?(c.href=`https://www.imdb.com/title/${r.imdb_id}/`,c.style.display="inline-flex"):c.style.display="none",m.style.display="flex",p?(Pe.src=`${Si}${p}?rel=0`,ut.classList.remove("hidden")):(Pe.src="",ut.classList.add("hidden"));const h=H.cloneNode(!0);H.parentNode.replaceChild(h,H),H=h,H.addEventListener("click",()=>{St();const g=document.getElementById("suggestionResultOverlay");g&&g.classList.contains("visible")&&g.classList.remove("visible"),Me(null,{title:r.title,tmdbId:r.id,poster:r.poster_path?Ue+r.poster_path:"",release_date:r.release_date,runtime:r.runtime,genres:r.genres,director:d})}),H.disabled=!1}catch(o){console.error("Film detayları yüklenirken hata oluştu:",o),De.textContent=s("error_occurred_title"),mt.textContent=s("details_error_loading").replace("{error}",o.message)}finally{i&&i.stop(),Te.style.display="none",dt.style.display="flex"}}function St(){A&&(Qe(),A.classList.remove("visible"),Pe.src="",A.addEventListener("transitionend",()=>{A.classList.contains("visible")||(A.classList.add("hidden"),A.classList.remove("is-layered"))},{once:!0}))}async function qi(e){e.preventDefault(),At();const t={id:oe.value||Date.now().toString(),tmdbId:se.value,title:C.value.trim(),poster:qe.value||"https://placehold.co/70x100/2A2A2A/AAAAAA?text=Poster+Yok",comment:_e.value,type:F.checked?"watch-later":"watched",runtime:parseInt(We.value,10)||0,director:ze.value||s("unknown"),genres:JSON.parse(Ye.value||"[]"),rating:F.checked?null:_,watchedDate:F.checked?null:E.value};if(t.type==="watched"&&(t.rating===0||!t.watchedDate)){z(s("notification_save_validation_fail"),"error");return}oe.value&&Le.value!==t.type&&await ka(oe.value,Le.value),await Ia(t),z(s("notification_movie_saved").replace("{title}",t.title),"success")}document.getElementById("loadingSpinnerOverlay");const Ve=document.querySelector(".particles-container");let be;const fn=["https://image.tmdb.org/t/p/w92/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg","https://image.tmdb.org/t/p/w92/rBF8wVQN8hTwsGPgWbARNIJyEj.jpg","https://image.tmdb.org/t/p/w92/qJ2tW6WMUDux911r6m7haRef0WH.jpg","https://image.tmdb.org/t/p/w92/2u7zbn8EudG6kLlJXPv2DEqv6H.jpg","https://image.tmdb.org/t/p/w92/suaEOtk1N1sgg2MTM7oZd2cfVp3.jpg","https://image.tmdb.org/t/p/w92/8OKmBV5BUFzmozIC3pPWKHy17kx.jpg","https://image.tmdb.org/t/p/w92/d5iIlFn5s0ImszYzrKYOFT0Rdl2.jpg","https://image.tmdb.org/t/p/w92/bX2xnavhMYjWDoZp1VM6VnU1xwe.jpg"];function Gi(){if(!Ve)return;const e=document.createElement("div");e.className="particle";const t=Math.random()*40+10,i=Math.random()*100,n=Math.random()*10+8,a=Math.random()*5,o=fn[Math.floor(Math.random()*fn.length)];e.style.width=`${t}px`,e.style.height=`${t}px`,e.style.left=`${i}%`,e.style.animationDuration=`${n}s`,e.style.animationDelay=`${a}s`,e.style.backgroundImage=`url(${o})`,Ve.appendChild(e),setTimeout(()=>{e.remove()},(n+a)*1e3)}function Wi(){be&&clearInterval(be),Ve&&(Ve.innerHTML=""),be=setInterval(Gi,200)}function Yi(){be&&clearInterval(be)}function Ie(e){const t=document.getElementById("loadingSpinnerOverlay");if(!t)return;const i=t.querySelector("dotlottie-player"),n=s("loading_texts"),a=e||(Array.isArray(n)?n[Math.floor(Math.random()*n.length)]:s("loading"));document.getElementById("splash-text").textContent=a,t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("visible"),Wi(),i&&i.play()},10)}function le(){const e=document.getElementById("loadingSpinnerOverlay");if(!e)return;const t=e.querySelector("dotlottie-player");t&&t.stop(),e.classList.remove("visible"),Yi(),e.addEventListener("transitionend",()=>{e.classList.contains("visible")||e.classList.add("hidden")},{once:!0})}const ke=[{id:"first_step",name:"badge_first_step_name",icon:"🚀",description:"badge_first_step_desc",condition:e=>e.totalMovies>=1},{id:"curious_viewer",name:"badge_curious_viewer_name",icon:"🧐",description:"badge_curious_viewer_desc",condition:e=>e.totalMovies>=10},{id:"cinephile",name:"badge_cinephile_name",icon:"📚",description:"badge_cinephile_desc",condition:e=>e.totalMovies>=50},{id:"film_gourmet",name:"badge_film_gourmet_name",icon:"🧑‍🍳",description:"badge_film_gourmet_desc",condition:e=>e.totalMovies>=100},{id:"sinelog_elite",name:"badge_sinelog_elite_name",icon:"👑",description:"badge_sinelog_elite_desc",condition:e=>e.totalMovies>=250},{id:"short_film_collector",name:"badge_short_film_collector_name",icon:"🎬",description:"badge_short_film_collector_desc",condition:e=>e.shortFilmCount>=5},{id:"marathoner",name:"badge_marathoner_name",icon:"🏃‍♂️",description:"badge_marathoner_desc",condition:e=>e.hasMarathonMovie},{id:"epic_viewer",name:"badge_epic_viewer_name",icon:"🗿",description:"badge_epic_viewer_desc",condition:e=>e.hasEpicMovie},{id:"one_day_filmgoer",name:"badge_one_day_filmgoer_name",icon:"🗓️",description:"badge_one_day_filmgoer_desc",condition:e=>e.totalRuntimeMinutes>=1440},{id:"10_day_filmgoer",name:"badge_10_day_filmgoer_name",icon:"🎖️",description:"badge_10_day_filmgoer_desc",condition:e=>e.totalRuntimeMinutes>=14400},{id:"critic",name:"badge_critic_name",icon:"✍️",description:"badge_critic_desc",condition:e=>e.commentedMoviesCount>=25},{id:"master_commentator",name:"badge_master_commentator_name",icon:"✒️",description:"badge_master_commentator_desc",condition:e=>e.commentedMoviesCount>=100},{id:"perfectionist",name:"badge_perfectionist_name",icon:"🌟",description:"badge_perfectionist_desc",condition:e=>e.fiveStarCount>=5},{id:"hard_to_please",name:"badge_hard_to_please_name",icon:"🤨",description:"badge_hard_to_please_desc",condition:e=>e.oneStarCount>=5},{id:"perfect_streak",name:"badge_perfect_streak_name",icon:"✨",description:"badge_perfect_streak_desc",condition:e=>e.perfectStreakCount>=3},{id:"genre_enthusiast",name:"badge_genre_enthusiast_name",icon:"🎭",description:"badge_genre_enthusiast_desc",condition:e=>e.maxFilmsInSingleGenre>=15},{id:"genre_expert",name:"badge_genre_expert_name",icon:"🎓",description:"badge_genre_expert_desc",condition:e=>e.maxFilmsInSingleGenre>=50},{id:"rainbow_palette",name:"badge_rainbow_palette_name",icon:"🎨",description:"badge_rainbow_palette_desc",condition:e=>e.uniqueGenreCount>=7},{id:"director_fan",name:"badge_director_fan_name",icon:"🏆",description:"badge_director_fan_desc",condition:e=>e.maxFilmsFromSingleDirector>=5},{id:"director_follower",name:"badge_director_follower_name",icon:"🎥",description:"badge_director_follower_desc",condition:e=>e.maxFilmsFromSingleDirector>=10},{id:"80s_kid",name:"badge_80s_kid_name",icon:"🕹️",description:"badge_80s_kid_desc",condition:e=>e.count80sFilms>=10},{id:"90s_spirit",name:"badge_90s_spirit_name",icon:"📼",description:"badge_90s_spirit_desc",condition:e=>e.count90sFilms>=15},{id:"millennium_cinephile",name:"badge_millennium_cinephile_name",icon:"💽",description:"badge_millennium_cinephile_desc",condition:e=>e.count00sFilms>=20},{id:"classic_master",name:"badge_classic_master_name",icon:"🎞️",description:"badge_classic_master_desc",condition:e=>e.countPre70sFilms>=10},{id:"documentary_buff",name:"badge_documentary_buff_name",icon:"🌍",description:"badge_documentary_buff_desc",condition:e=>e.documentaryCount>=5},{id:"weekend_warrior",name:"badge_weekend_warrior_name",icon:"🍿",description:"badge_weekend_warrior_desc",condition:e=>e.maxMoviesInWeekend>=5},{id:"double_feature",name:"badge_double_feature_name",icon:"✌️",description:"badge_double_feature_desc",condition:e=>e.maxMoviesInDay>=2},{id:"loyal_friend",name:"badge_loyal_friend_name",icon:"🤝",description:"badge_loyal_friend_desc",condition:e=>e.accountAgeInDays>=365},{id:"animator",name:"badge_animator_name",icon:"🦄",description:"badge_animator_desc",condition:e=>e.animationCount>=5},{id:"collector",name:"badge_collector_name",icon:"💎",description:"badge_collector_desc",condition:(e,t)=>t.length>=15}];function zi(e){let t=ke.filter(n=>n.id==="collector"?!1:n.condition(e));const i=ke.find(n=>n.id==="collector");return i&&i.condition(e,t)&&t.push(i),t}let k,On,Hn,Nn,gt;function Vi(){if(k=document.getElementById("badge-info-modal"),k?.querySelector(".micro-modal-content"),On=document.getElementById("badge-info-icon"),Hn=document.getElementById("badge-info-name"),Nn=document.getElementById("badge-info-description"),gt=document.getElementById("badge-info-close-btn"),!k||!gt){console.error("Rozet bilgi modalı DOM elementleri bulunamadı.");return}gt.addEventListener("click",vn),k.addEventListener("click",e=>{e.target===k&&vn()})}function Ki(e){!e||!k||(On.textContent=e.icon,Hn.textContent=s(e.name),Nn.textContent=s(e.description),k.classList.remove("hidden"),setTimeout(()=>{k.classList.add("visible")},10))}function vn(){k&&(k.classList.remove("visible"),k.addEventListener("transitionend",()=>{k.classList.contains("visible")||k.classList.add("hidden")},{once:!0}))}function jn(e){let t='<span class="flex items-center">';const i="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.921-7.417 3.921 1.481-8.279-6.064-5.828 8.332-1.151z",n="halfStarGradient";for(let a=1;a<=5;a++){let o;e>=a?o="var(--accent-secondary)":e===a-.5?o=`url(#${n})`:o="#484f58",t+=`<svg class="star-display-svg" viewBox="0 0 24 24" width="1.1em" height="1.1em" fill="${o}"><path d="${i}"/></svg>`}return t+="</span>",t}function Ji(e,t,i,n){if(e.replaceChildren(),t.length===0){i.style.display="block";return}i.style.display="none",t.forEach(a=>{const o=document.createElement("div");o.className="movie-item";const l=document.createElement("img");l.className="movie-poster",l.src=a.poster||"fallback-image.png",l.alt=`${a.title} Poster`,l.addEventListener("error",()=>{l.src="https://placehold.co/70x100/2A2A2A/AAAAAA?text=Poster+Yok"},{once:!0});const r=document.createElement("div");r.className="movie-details";const d=document.createElement("div");d.className="movie-title",d.textContent=a.title;const p=document.createElement("div");p.innerHTML=jn(a.rating);const f=document.createElement("div");if(f.className="watched-date",f.textContent=Ai(a.watchedDate),r.append(d,p,f),a.comment){const m=document.createElement("p");m.className="short-comment",m.textContent=a.comment,m.addEventListener("click",h=>{h.stopPropagation(),m.classList.toggle("expanded")}),r.appendChild(m)}const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("fill","none"),c.setAttribute("viewBox","0 0 24 24"),c.setAttribute("stroke-width","2.5"),c.setAttribute("stroke","currentColor"),c.classList.add("w-5","h-5","text-gray-400","self-center","ml-2"),c.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />',o.append(l,r,c),o.addEventListener("click",()=>{n(a.id,null,"watched")}),e.appendChild(o)})}function Un(e,t,i,n){if(e.innerHTML="",t.length===0){i.style.display="block";return}i.style.display="none",t.forEach(a=>{const o=document.createElement("div");o.classList.add("movie-item"),o.innerHTML=`
            <img src="${a.poster}" alt="${a.title} Poster" class="movie-poster" onerror="this.onerror=null;this.src='https://placehold.co/70x100/2A2A2A/AAAAAA?text=Poster+Yok';">
            <div class="movie-details">
                <div class="movie-title">${a.title}</div>
                <p class="short-comment">${s("watch_later_status")}</p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 text-gray-400 self-center ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
        `,o.addEventListener("click",()=>{n(a.id,null,"watch-later")}),e.appendChild(o)})}function Qi(e,t){const i=document.getElementById("trending-movies-grid");i.innerHTML="",e.forEach(n=>{const a=document.createElement("div");a.classList.add("trending-item"),a.innerHTML=`<img src="${n.poster_path?Ze+n.poster_path:"https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok"}" alt="${n.title}" class="trending-poster" onerror="this.onerror=null;this.src='https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok';"><div class="trending-title">${n.title}</div>`,a.addEventListener("click",()=>t(n.id)),i.appendChild(a)})}function Zi(e,t){t.innerHTML="",t.classList.remove("hidden"),e.slice(0,5).forEach(i=>{const n=document.createElement("div");n.classList.add("tmdb-result-item"),n.innerHTML=`<img src="${i.poster_path?Ue+i.poster_path:"https://placehold.co/40x60/2A2A2A/AAAAAA?text=Yok"}" alt="${i.title}" class="tmdb-result-poster"><div class="tmdb-result-details"><div class="tmdb-result-title">${i.title}</div><div class="tmdb-result-year">${i.release_date?i.release_date.substring(0,4):""}</div></div>`,n.addEventListener("click",async()=>{const a=document.getElementById("movie-title-input"),o=document.getElementById("movie-poster-input"),l=document.getElementById("movie-date-input"),r=document.getElementById("movie-runtime-input"),d=document.getElementById("movie-genres-input"),p=document.getElementById("movie-director-input"),f=document.getElementById("movie-tmdb-id"),c=document.getElementById("chat-with-character-button"),m=document.getElementById("watch-later-checkbox"),h=document.getElementById("tmdb-search-message");h.textContent=`'${i.title}' detayları yükleniyor...`,h.style.display="block",t.classList.add("hidden");try{const{movieData:g,directorName:v}=await Xe(i.id);a.value=g.title,o.value=g.poster_path?Ue+g.poster_path:"",r.value=g.runtime||0,d.value=JSON.stringify(g.genres||[]),p.value=v||"Bilinmiyor",f.value=i.id,l.value||(l.value=g.release_date||new Date().toISOString().split("T")[0]),h.style.display="none",a.readOnly=!0,m.checked||c.classList.remove("hidden")}catch(g){console.error("Arama sonucundan detay çekerken hata:",g),h.textContent=s("error_loading_details").replace("{error}",g.message)}}),t.appendChild(n)})}function Xi(e){const t=document.getElementById("profile-hero"),i=document.getElementById("cinematic-identity-badge"),n=document.getElementById("profile-stats-panel");if(!t||!i||!n)return;if(e.topRatedMovie&&e.topRatedMovie.poster){const c=e.topRatedMovie.poster.replace(Ue,"");t.style.backgroundImage=`url(${Dn}${c})`}else t.style.backgroundImage="none";if(i.textContent=e.cinematicIdentity,n.innerHTML="",e.totalMovies===0){n.innerHTML=`<p class="text-gray-400 text-center col-span-full p-4">${s("profile_empty_message")}</p>`;return}let a="";const o=[{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',value:e.totalMovies,label:s("stat_total_movies")},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',value:e.avgRating.toFixed(1),label:s("stat_avg_rating")},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',value:e.totalWatchTime,label:s("stat_total_time")}];let l='<div class="stat-group" style="--animation-delay: 0ms;"><div class="overview-grid">';o.forEach(c=>{l+=`<div class="overview-card"><div class="overview-icon">${c.icon}</div><div class="overview-text"><span class="overview-value">${c.value}</span><span class="overview-label">${c.label}</span></div></div>`}),l+="</div></div>",a+=l;const r=Object.values(e.ratingDistribution).reduce((c,m)=>c+m,0);if(r>0){let c=`<div class="stat-group" style="--animation-delay: 200ms;"><h3 class="stat-group-title">${s("stat_rating_dist")}</h3><ul class="stat-list">`;Object.keys(e.ratingDistribution).sort((h,g)=>parseFloat(g)-parseFloat(h)).forEach(h=>{const g=e.ratingDistribution[h],v=g/r*100;c+=`<li class="rating-bar-container" data-rating="${h}"><div class="rating-bar-label">${jn(parseFloat(h))}</div><div class="rating-bar"><div class="rating-bar-fill" style="width: 0%;" data-width="${v}%"></div></div><span class="rating-bar-count">${g}</span></li>`}),c+="</ul></div>",a+=c}if(e.badges){const{all:c,earned:m}=e.badges,h=new Set(m.map(v=>v.id));let g=`<div class="stat-group" style="--animation-delay: 300ms;"><div class="badge-group-header"><h3 class="stat-group-title">${s("stat_badge_collection")}</h3><span class="badge-count">${m.length} / ${c.length}</span></div>`;if(m.length>0){const v=m[m.length-1];g+=`<div class="badge-showcase" data-badge-id="${v.id}"><div class="featured-badge"><div class="featured-badge-icon">${v.icon}</div><span class="featured-badge-name">${s(v.name)}</span><span class="featured-badge-label">${s("stat_latest_badge")}</span></div><div class="other-badges">`,m.slice(-5,-1).reverse().forEach(L=>{g+=`<div class="badge-icon-preview" title="${s(L.name)}" data-badge-id="${L.id}">${L.icon}</div>`}),g+="</div></div>"}g+='<div id="badge-collection-grid" class="badge-collection-grid">',c.forEach(v=>{const L=h.has(v.id);g+=`<div class="badge-card ${L?"earned":"locked"}" data-badge-id="${v.id}"><div class="badge-icon">${v.icon}</div><div class="badge-text"><span class="badge-name">${s(v.name)}</span>${L?"":`<span class="badge-locked-text">${s("badge_locked")}</span>`}</div></div>`}),g+="</div>",c.length>0&&(g+=`<button id="toggle-badges-btn" class="toggle-badges-btn">${s("stat_view_collection")}</button>`),g+="</div>",a+=g}n.innerHTML=a;const d=document.getElementById("profile-stats-panel");d&&d.addEventListener("click",c=>{const m=c.target.closest(".badge-card, .featured-badge, .badge-icon-preview");if(m){const h=m.dataset.badgeId,g=ke.find(v=>v.id===h);g&&Ki(g)}});const p=document.getElementById("toggle-badges-btn"),f=document.getElementById("badge-collection-grid");p&&f&&p.addEventListener("click",()=>{f.classList.toggle("expanded"),p.textContent=f.classList.contains("expanded")?s("stat_hide_collection"):s("stat_view_collection")}),setTimeout(()=>{document.querySelectorAll(".rating-bar-fill").forEach(c=>c.style.width=c.dataset.width)},100)}function ea(e,t,i){e.innerHTML=`<h2 class="text-xl font-bold mb-4 text-gray-200">${s("special_lists_title")}</h2>`;const n=document.createElement("div");n.className="special-lists-container",t.forEach((a,o)=>{const l=document.createElement("div");l.className="list-card-v3",l.style.setProperty("--animation-delay",`${o*80}ms`);const r=a.heroImage||"https://placehold.co/300x450/161b22/8b949e?text=SineLog";l.innerHTML=`
            <div class="list-card-image-wrapper">
                <div class="list-card-bg-image" style="background-image: url(${r})"></div>
                
                <img src="${r}" alt="${a.name}" class="list-card-fg-image" onerror="this.style.display='none'">
            </div>
            <div class="list-card-text-content">
                <div>
                    <h3 class="list-card-title">${s(a.name)}</h3>
                    <p class="list-card-description">${s(a.description)}</p>
                </div>
                <div class="list-card-chevron">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </div>
            </div>
        `,l.addEventListener("click",()=>i(a)),n.appendChild(l)}),e.appendChild(n)}function ta(e,t,i){if(e.innerHTML="",t.length===0){e.innerHTML=`<p class="text-gray-500 text-center col-span-full">${s("list_empty_message")}</p>`;return}t.forEach(n=>{const a=document.createElement("div");a.classList.add("trending-item"),a.innerHTML=`<img src="${n.poster_path?Ze+n.poster_path:"https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok"}" alt="${n.title}" class="trending-poster" onerror="this.onerror=null;this.src='https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok';"><div class="trending-title">${n.title}</div>`,a.addEventListener("click",()=>i(n.id)),e.appendChild(a)})}function na(e){if(e===0)return s("time_zero_minutes");const t=Math.floor(e/60),i=e%60;let n="";return t>0&&(n+=`${t} ${s("time_hours")} `),i>0&&(n+=`${i} ${s("time_minutes")}`),n.trim()}function ia(e){if(e.totalMovies<5)return s("identity_newbie");if(e.topGenres.length>0)switch(e.topGenres[0].name){case"Aksiyon":return s("identity_action_lover");case"Bilim-Kurgu":return s("identity_sci_fi_explorer");case"Komedi":return s("identity_comedy_fan");case"Dram":return s("identity_dramatic_soul");default:return s("identity_eclectic_taste")}return s("identity_diverse_taste")}function aa(e){if(!e||e.length===0)return{totalMovies:0,avgRating:0,watchedThisYear:0,topRatedMovie:null,totalWatchTime:"0 dakika",topGenres:[],topDirectors:[],ratingDistribution:{},cinematicIdentity:s("identity_awaiting_discovery"),timeCapsule:null,badges:{all:ke,earned:[]}};let t=0,i=0,n=null,a=0,o=0,l=0,r=0,d=0,p=0,f=0,c=!1,m=!1,h=0,g=0,v=0,L=0,zt=0,Vt=0;const de={},Ae={},et={},me={},ue={},Z=[...e].sort((u,y)=>new Date(u.watchedDate)-new Date(y.watchedDate));Z.forEach(u=>{u.rating&&u.rating>0&&(t+=parseFloat(u.rating),i++,(!n||u.rating>n.rating)&&(n=u),et[u.rating.toString()]=(et[u.rating.toString()]||0)+1,u.rating===5?(r++,p++):(p>f&&(f=p),p=0),u.rating<=1&&d++),u.comment&&u.comment.trim()!==""&&l++,typeof u.runtime=="number"&&u.runtime>0&&(a+=u.runtime,u.runtime<60&&o++,u.runtime>=180&&(c=!0),u.runtime>=240&&(m=!0));const y=u.genres?.map(b=>b.name)||[];if(y.forEach(b=>de[b]=(de[b]||0)+1),u.director&&u.director!=="Bilinmiyor"&&(Ae[u.director]=(Ae[u.director]||0)+1),y.includes("Animasyon")&&zt++,y.includes("Belgesel")&&Vt++,u.watchedDate){const b=new Date(u.watchedDate),O=b.toLocaleString("tr-TR",{month:"long",year:"numeric"});me[O]=(me[O]||0)+1;const ge=b.toDateString();ue[ge]=(ue[ge]||0)+1;const x=u.release_date?parseInt(u.release_date.substring(0,4),10):0;x>=1980&&x<=1989?h++:x>=1990&&x<=1999?g++:x>=2e3&&x<=2009?v++:x<1970&&L++}}),p>f&&(f=p);let tt=0;const Kt=new Set;Object.keys(ue).forEach(u=>{const y=new Date(u),b=y.getDay();if(b===0||b===5||b===6){const O=new Date(y);O.setDate(O.getDate()-(b===0?-5:b-5));const ge=O.toDateString();if(!Kt.has(ge)){let x=0;for(let nt=0;nt<3;nt++){const Qt=new Date(O);Qt.setDate(O.getDate()+nt),x+=ue[Qt.toDateString()]||0}x>tt&&(tt=x),Kt.add(ge)}}});const Zn={totalMovies:e.length,totalRuntimeMinutes:a,shortFilmCount:o,hasMarathonMovie:c,hasEpicMovie:m,maxFilmsFromSingleDirector:Math.max(0,...Object.values(Ae)),maxFilmsInSingleGenre:Math.max(0,...Object.values(de)),uniqueGenreCount:Object.keys(de).length,count80sFilms:h,count90sFilms:g,count00sFilms:v,countPre70sFilms:L,commentedMoviesCount:l,fiveStarCount:r,oneStarCount:d,perfectStreakCount:f,animationCount:zt,documentaryCount:Vt,maxMoviesInDay:Math.max(0,...Object.values(ue)),maxMoviesInWeekend:tt,accountAgeInDays:(new Date-new Date(Z[0].watchedDate))/(1e3*60*60*24)},Xn=zi(Zn),Jt=Object.entries(de).sort(([,u],[,y])=>y-u).slice(0,3).map(([u,y])=>({name:u,count:y})),ei={onThisDay:Z.find(u=>{const y=new Date(u.watchedDate),b=new Date;return y.getDate()===b.getDate()&&y.getMonth()===b.getMonth()&&y.getFullYear()<b.getFullYear()}),firstLogged:Z[0]||null,firstFiveStar:Z.find(u=>u.rating===5)||null,mostWatchedMonth:Object.entries(me).sort(([,u],[,y])=>y-u)[0]?{month:Object.entries(me).sort(([,u],[,y])=>y-u)[0][0],count:Object.entries(me).sort(([,u],[,y])=>y-u)[0][1]}:null};return{totalMovies:e.length,avgRating:i>0?t/i:0,watchedThisYear:Z.filter(u=>new Date(u.watchedDate).getFullYear()===new Date().getFullYear()).length,topRatedMovie:n,totalWatchTime:na(a),topGenres:Jt,topDirectors:Object.entries(Ae).sort(([,u],[,y])=>y-u).slice(0,3).map(([u,y])=>({name:u,count:y})),ratingDistribution:et,cinematicIdentity:ia({totalMovies:e.length,topGenres:Jt}),timeCapsule:ei,badges:{all:ke,earned:Xn}}}const oa={28:"genre_Action",12:"genre_Adventure",16:"genre_Animation",35:"genre_Comedy",80:"genre_Crime",99:"genre_Documentary",18:"genre_Drama",10751:"genre_Family",14:"genre_Fantasy",36:"genre_History",27:"genre_Horror",10402:"genre_Music",9648:"genre_Mystery",10749:"genre_Romance",878:"genre_Science_Fiction",10770:"genre_TV_Movie",53:"genre_Thriller",10752:"genre_War",37:"genre_Western"};let M,yn,_n,bn,Re,Fe,Gt,w,I,we,Ct,Dt;function sa(e){if(M=document.getElementById("filter-modal-overlay"),yn=document.getElementById("apply-filter-btn"),_n=document.getElementById("clear-filter-btn"),bn=document.getElementById("close-filter-modal-button"),w=document.getElementById("rating-slider-min"),I=document.getElementById("rating-slider-max"),we=document.getElementById("slider-progress"),Ct=document.getElementById("rating-min-value"),Dt=document.getElementById("rating-max-value"),!M||!w)return;Gt=e,yn.addEventListener("click",ca),_n.addEventListener("click",da),bn.addEventListener("click",Ke),M.addEventListener("click",i=>{i.target===M&&Ke()});function t(){const i=parseFloat(w.value),n=parseFloat(I.value);Ct.textContent=i.toFixed(1),Dt.textContent=n.toFixed(1);const a=(i-w.min)/(w.max-w.min)*100,o=(n-I.min)/(I.max-I.min)*100;we.style.left=`${a}%`,we.style.right=`${100-o}%`}w.addEventListener("input",()=>{parseFloat(w.value)>parseFloat(I.value)&&(w.value=I.value),t()}),I.addEventListener("input",()=>{parseFloat(I.value)<parseFloat(w.value)&&(I.value=w.value),t()})}function ra(e,t){M&&(la(e,t),M.classList.remove("hidden"),setTimeout(()=>M.classList.add("visible"),10))}function Ke(){M&&(M.classList.remove("visible"),M.addEventListener("transitionend",()=>{M.classList.contains("visible")||M.classList.add("hidden")},{once:!0}))}function la(e,t){const i=new Map;let n=new Date().getFullYear(),a=1900;e.forEach(c=>{c.genres?.forEach(h=>i.set(h.id,h.name));const m=c.release_date?parseInt(c.release_date.substring(0,4)):0;m&&(m<n&&(n=m),m>a&&(a=m))});const o=document.getElementById("genre-filter-container");o.innerHTML="",[...i.entries()].sort((c,m)=>c[0]-m[0]).forEach(([c,m])=>{const h=t.genres?.includes(m)?"checked":"",g=oa[c]||`genre_${m.replace(/[\s-]/g,"_")}`,v=s(g);o.innerHTML+=`<label class="genre-filter-label"><input type="checkbox" name="genre" value="${m}" ${h}><span>${v}</span></label>`});const r=t.ratingRange?t.ratingRange[0]:1,d=t.ratingRange?t.ratingRange[1]:5;w.value=r,I.value=d,Ct.textContent=parseFloat(r).toFixed(1),Dt.textContent=parseFloat(d).toFixed(1);const p=(r-w.min)/(w.max-w.min)*100,f=(d-I.min)/(I.max-I.min)*100;we.style.left=`${p}%`,we.style.right=`${100-f}%`,Re=document.getElementById("year-start-input"),Fe=document.getElementById("year-end-input"),Re.placeholder=n,Fe.placeholder=a,Re.value=t.yearRange&&t.yearRange[0]||"",Fe.value=t.yearRange&&t.yearRange[1]||""}function ca(){const e=[...document.querySelectorAll("#genre-filter-container input:checked")].map(a=>a.value),t=[parseFloat(w.value),parseFloat(I.value)],i=[parseInt(Re.value,10)||null,parseInt(Fe.value,10)||null],n={};e.length>0&&(n.genres=e),(t[0]>1||t[1]<5)&&(n.ratingRange=t),(i[0]||i[1])&&(n.yearRange=i),Gt(n),Ke()}function da(){Gt({}),Ke()}function ma(e,t){return e.filter(i=>{if(t.genres&&t.genres.length>0){const n=i.genres?.map(a=>a.name)||[];if(!t.genres.some(a=>n.includes(a)))return!1}if(t.ratingRange&&(!i.rating||i.rating<t.ratingRange[0]||i.rating>t.ratingRange[1]))return!1;if(t.yearRange){const n=i.release_date?parseInt(i.release_date.substring(0,4)):0;if(!n||t.yearRange[0]&&n<t.yearRange[0]||t.yearRange[1]&&n>t.yearRange[1])return!1}return!0})}const ua=[{id:"top_rated_all_time",name:"list_top_rated_all_time_name",description:"list_top_rated_all_time_desc",type:"endpoint",tmdbId:"/movie/top_rated"},{id:"harry_potter_collection",name:"list_harry_potter_collection_name",description:"list_harry_potter_collection_desc",type:"collection",tmdbId:"1241"},{id:"oscars_2024_winners",name:"list_oscars_2024_winners_name",description:"list_oscars_2024_winners_desc",type:"manual",tmdbId:[872585,792307,915935,840430,467244,363215,508883]},{id:"christopher_nolan_films",name:"list_christopher_nolan_films_name",description:"list_christopher_nolan_films_desc",type:"director",tmdbId:"525"},{id:"ghibli_magic",name:"list_ghibli_magic_name",description:"list_ghibli_magic_desc",type:"endpoint",tmdbId:"/discover/movie?with_companies=10342&sort_by=vote_average.desc"},{id:"action_packed_adrenaline",name:"list_action_packed_adrenaline_name",description:"list_action_packed_adrenaline_desc",type:"endpoint",tmdbId:"/discover/movie?with_genres=28&sort_by=popularity.desc&primary_release_date.gte=2015-01-01"},{id:"mcu_phase_one",name:"list_mcu_phase_one_name",description:"list_mcu_phase_one_desc",type:"collection",tmdbId:"86311"},{id:"quentin_tarantino_films",name:"list_quentin_tarantino_films_name",description:"list_quentin_tarantino_films_desc",type:"director",tmdbId:"138"},{id:"lord_of_the_rings_trilogy",name:"list_lord_of_the_rings_trilogy_name",description:"list_lord_of_the_rings_trilogy_desc",type:"collection",tmdbId:"119"}];function ga(){return ua}const qn=document.getElementById("my-watched-movies-section"),pa=document.getElementById("my-movies-list"),ha=document.getElementById("my-movies-empty-message"),N=document.getElementById("sort-button"),ee=document.getElementById("sort-options-menu"),wn=document.querySelectorAll(".sort-option"),Tt=document.getElementById("filter-button"),fa=document.getElementById("trending-movies-section"),va=document.getElementById("trending-movies-grid"),pe=document.getElementById("trending-error-message"),ya=document.getElementById("special-lists-section"),Gn=document.getElementById("list-detail-section"),pt=document.getElementById("list-detail-title"),En=document.getElementById("list-detail-grid"),Wn=document.getElementById("watch-later-movies-section"),Yn=document.getElementById("watch-later-movies-list"),zn=document.getElementById("watch-later-empty-message"),_a=document.getElementById("profile-section"),Ln=document.getElementById("profile-logged-in-view"),In=document.getElementById("profile-logged-out-view"),kn=document.getElementById("add-movie-float-button");document.getElementById("special-lists-loader");const $e=document.getElementById("special-lists-content-container");let Vn="date-desc",Oe={};function Be(e){if(qn.classList.contains("hidden"))return;e!==void 0&&(Oe=e),Tt.classList.toggle("active",Object.keys(Oe).length>0);const i=[...ma(ce,Oe)];switch(Vn){case"date-desc":i.sort((a,o)=>new Date(o.watchedDate)-new Date(a.watchedDate));break;case"date-asc":i.sort((a,o)=>new Date(a.watchedDate)-new Date(o.watchedDate));break;case"rating-desc":i.sort((a,o)=>(o.rating||0)-(a.rating||0));break;case"rating-asc":i.sort((a,o)=>(a.rating||0)-(o.rating||0));break;case"title-asc":i.sort((a,o)=>a.title.localeCompare(o.title));break}Ji(pa,i,ha,Me);const n=ee.querySelector(".sort-option.active");n&&(N.querySelector("span").textContent=`${s("sort_button_prefix")} ${s(n.dataset.i18n)}`)}function Kn(){Wn.classList.contains("hidden")||Un(Yn,xe,zn,Me)}function ba(){!N||!ee||!Tt||(sa(Be),N.addEventListener("click",e=>{e.stopPropagation(),ee.classList.toggle("hidden"),N.classList.toggle("open")}),wn.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),wn.forEach(i=>i.classList.remove("active")),e.classList.add("active"),Vn=e.dataset.sort,N.querySelector("span").textContent=`${s("sort_button_prefix")} ${s(e.dataset.i18n)}`,ee.classList.add("hidden"),N.classList.remove("open"),Be()})}),Tt.addEventListener("click",()=>{ra(ce,Oe)}),document.addEventListener("click",e=>{!N.contains(e.target)&&!ee.classList.contains("hidden")&&(ee.classList.add("hidden"),N.classList.remove("open"))}))}function He(e){if(e&&!e.isAnonymous){In.classList.add("hidden"),Ln.classList.remove("hidden"),document.getElementById("profile-name").textContent=e.email.split("@")[0],document.getElementById("profile-email").textContent=e.email;const t=aa(ce);Xi(t)}else Ln.classList.add("hidden"),In.classList.remove("hidden")}async function wa(e){document.querySelectorAll(".content-section").forEach(t=>t.classList.add("hidden")),Gn.classList.remove("hidden"),pt.textContent=s("loading"),Ie("Liste detayları getiriliyor...");try{const t=await Tn(e);pt.textContent=e.name,ta(En,t,qt)}catch{pt.textContent="Hata",En.innerHTML=`<p class="text-red-400 text-center col-span-full">${s("list_load_error")}</p>`}finally{le()}}async function U(e){const t=[fa,qn,Wn,_a,ya,Gn],i=document.querySelectorAll(".nav-item");if(t.forEach(n=>{n.classList.toggle("hidden",n.id!==e)}),i.forEach(n=>{let a="";e==="my-watched-movies-section"?a="nav-my-log":e==="trending-movies-section"?a="nav-trending":e==="special-lists-section"?a="nav-lists":e==="watch-later-movies-section"?a="nav-watch-later":e==="profile-section"&&(a="nav-profile"),n.classList.toggle("active",n.id===a)}),e==="my-watched-movies-section"||e==="watch-later-movies-section"?kn.style.display="flex":kn.style.display="none",pe.style.display="none",e==="my-watched-movies-section")Be();else if(e==="trending-movies-section"){Ie(),va.innerHTML="";const n=new Promise(o=>setTimeout(o,1300)),a=Ci();try{const[o,l]=await Promise.all([n,a]);l.length===0?(pe.textContent=s("trending_no_movies_found"),pe.style.display="block"):Qi(l,qt)}catch(o){pe.textContent=s("trending_error").replace("{error}",o.message),pe.style.display="block"}finally{le()}}else if(e==="special-lists-section"){Ie(),$e.innerHTML="",$e.classList.add("hidden");const n=new Promise(r=>setTimeout(r,1300)),a=(async()=>{const r=ga(),d=r.map(f=>Tn(f)),p=await Promise.all(d);return r.map((f,c)=>{const m=p[c].find(h=>h.poster_path);return{...f,heroImage:m?`https://image.tmdb.org/t/p/w500${m.poster_path}`:null}})})(),[o,l]=await Promise.all([n,a]);le(),$e.classList.remove("hidden"),ea($e,l,wa)}else e==="watch-later-movies-section"?Un(Yn,xe,zn,Me):e==="profile-section"&&He(P.currentUser)}document.getElementById("back-to-lists-btn").addEventListener("click",()=>{U("special-lists-section")});let ce=[],xe=[],$t=null,Pt=null;function Jn(){$t&&$t(),Pt&&Pt()}function Ea(e){return new Promise((t,i)=>{Jn();let n=!1,a=!1;const o=()=>{n&&a&&(console.log("Initial data from both collections loaded."),t())},l=Zt(Ee,"users",e,"watchedMovies");$t=Xt(l,d=>{ce=d.docs.map(p=>({id:p.id,...p.data()})),Be(),n||(n=!0,o())},d=>{console.error("Watched movies listener error:",d),i(d)});const r=Zt(Ee,"users",e,"watchLaterMovies");Pt=Xt(r,d=>{xe=d.docs.map(p=>({id:p.id,...p.data()})),Kn(),a||(a=!0,o())},d=>{console.error("Watch later listener error:",d),i(d)})})}function La(){Jn(),ce=[],xe=[],console.log("Local movie lists cleared.")}async function Ia(e){const t=P.currentUser?.uid;if(!t)return console.error("User not authenticated to save movie.");const{id:i,type:n,...a}=e,o=n==="watched"?"watchedMovies":"watchLaterMovies";if(!i)return console.error("Movie ID is missing. Cannot save movie.");const l=Nt(Ee,"users",t,o,i);try{await ai(l,a,{merge:!0}),console.log(`Movie ${i} saved to ${o}`)}catch(r){console.error("Error saving movie: ",r)}}async function ka(e,t){const i=P.currentUser?.uid;if(!i)return console.error("User not authenticated to delete movie.");if(!e||!t)return console.error("Movie ID or list type is missing.");const n=t==="watched"?"watchedMovies":"watchLaterMovies",a=Nt(Ee,"users",i,n,e);try{await ii(a),console.log(`Movie ${e} deleted from ${n}`)}catch(o){console.error("Error deleting movie: ",o)}}function Ba(){document.getElementById("nav-my-log")?.addEventListener("click",()=>U("my-watched-movies-section")),document.getElementById("nav-trending")?.addEventListener("click",()=>U("trending-movies-section")),document.getElementById("nav-lists")?.addEventListener("click",()=>U("special-lists-section")),document.getElementById("nav-watch-later")?.addEventListener("click",()=>U("watch-later-movies-section")),document.getElementById("nav-profile")?.addEventListener("click",()=>U("profile-section")),document.getElementById("add-movie-float-button")?.addEventListener("click",()=>Me()),document.getElementById("sign-out-button")?.addEventListener("click",Mi);const e=document.getElementById("movie-details-modal-overlay");document.getElementById("close-detail-modal-button")?.addEventListener("click",()=>St()),e&&e.addEventListener("click",n=>{n.target===e&&St()});const t=document.getElementById("email-auth-form");if(t){const n=document.getElementById("auth-tab-login"),a=document.getElementById("auth-tab-signup"),o=document.getElementById("auth-submit-button"),l=document.getElementById("auth-error-message"),r=document.getElementById("auth-email");document.getElementById("auth-email-error");const d=document.getElementById("auth-password"),p=document.getElementById("auth-password-toggle"),f=document.getElementById("eye-open-icon"),c=document.getElementById("eye-closed-icon");n&&n.addEventListener("click",()=>{n.classList.add("active"),a.classList.remove("active"),o.textContent="Giriş Yap",l.classList.add("hidden")}),a&&a.addEventListener("click",()=>{a.classList.add("active"),n.classList.remove("active"),o.textContent="Kayıt Ol",l.classList.add("hidden")}),p&&p.addEventListener("click",()=>{const m=d.type==="password";d.type=m?"text":"password",f?.classList.toggle("hidden",m),c?.classList.toggle("hidden",!m)}),t.addEventListener("submit",async m=>{m.preventDefault();const h=r.value,g=d.value,v=n.classList.contains("active");l.classList.add("hidden"),o.disabled=!0;try{if(v)await Bi(h,g),z(s("notification_login_success"),"success");else{const L=await ki(h,g);z(s("notification_signup_success"),"success"),t.reset()}}catch(L){console.error("Authentication Error:",L),l.textContent=Ma(L),l.classList.remove("hidden")}finally{o.disabled=!1}})}const i=document.querySelectorAll(".plan-option");i.forEach(n=>{n.addEventListener("click",()=>{i.forEach(a=>{a.classList.remove("selected")}),n.classList.add("selected")})})}function Ma(e){switch(e.code){case"auth/invalid-email":return s("auth_error_invalid_email");case"auth/user-not-found":case"auth/wrong-password":case"auth/invalid-credential":return s("auth_error_wrong_password");case"auth/email-already-in-use":return s("auth_error_email_in_use");case"auth/weak-password":return s("auth_error_weak_password");default:return s("auth_error_default")}}let ht,D,Bn,Wt,Mn,T,$,xn,Rt,An,Yt="";function xa(){if(ht=document.getElementById("suggestMovieBtn"),D=document.getElementById("promptModalOverlay"),Bn=document.getElementById("closePromptModalBtn"),Wt=document.getElementById("moviePromptInput"),Mn=document.getElementById("submitPromptBtn"),T=document.getElementById("promptError"),$=document.getElementById("suggestionResultOverlay"),xn=document.getElementById("closeSuggestionResultBtn"),Rt=document.getElementById("suggestionGrid"),An=document.getElementById("tryAgainBtn"),!ht||!D||!$){console.error("Film öneri DOM elementlerinden bazıları bulunamadı.");return}ht.addEventListener("click",()=>{je()?Ft():_t()}),Bn.addEventListener("click",Ot),D.addEventListener("click",e=>{e.target===D&&Ot()}),Mn.addEventListener("click",Da),xn.addEventListener("click",Ht),$.addEventListener("click",e=>{e.target===$&&Ht()}),An.addEventListener("click",Ca)}function Ft(){Je(),Wt.value="",T.textContent="",T.classList.add("hidden"),D.classList.remove("hidden"),setTimeout(()=>D.classList.add("visible"),10)}function Ot(){Qe(),D.classList.remove("visible"),setTimeout(()=>{document.querySelector(".modal-overlay.visible")},100),D.addEventListener("transitionend",()=>{D.classList.contains("visible")||D.classList.add("hidden")},{once:!0})}function Aa(e){Je(),Sa(e),$.classList.remove("hidden"),setTimeout(()=>$.classList.add("visible"),10)}function Ht(){Qe(),$.classList.remove("visible"),setTimeout(()=>{document.querySelector(".modal-overlay.visible")},100),$.addEventListener("transitionend",()=>{$.classList.contains("visible")||$.classList.add("hidden")},{once:!0})}function Sa(e){Rt.innerHTML="",e.slice(0,4).forEach(t=>{if(!t||!t.id)return;const i=document.createElement("div");i.className="suggestion-poster-item";const n=document.createElement("img");n.src=t.poster_path?`https://image.tmdb.org/t/p/w500${t.poster_path}`:"https://placehold.co/400x600/2A2A2A/AAAAAA?text=Poster+Yok",n.alt=t.title,n.onerror=function(){this.onerror=null,this.src="https://placehold.co/400x600/2A2A2A/AAAAAA?text=Poster+Yok"},i.appendChild(n),i.addEventListener("click",()=>{qt(t.id,!0)}),Rt.appendChild(i)})}async function Ca(){Yt&&(Ht(),await Qn(!0))}async function Da(){const e=Wt.value.trim();if(!e){T.textContent="Lütfen bir film öneri isteği girin.",T.classList.remove("hidden");return}Yt=e,T.classList.add("hidden"),Ot(),await Qn()}async function Qn(e=!1){const t=s(e?"ai_loading_retry":"ai_loading_initial");Ie(t);try{const i=await Ti(Yt,e);if(le(),i&&i.movies&&i.movies.length>0)Aa(i.movies);else{const n=i.error||"İsteğine uygun filmler bulunamadı. Lütfen daha farklı bir dilde veya içerikte tekrar dene.";Ft(),T.textContent=n,T.classList.remove("hidden")}}catch(i){le(),console.error("Film önerisi alınırken hata:",i),Ft(),T.textContent=`Bir hata oluştu: ${i.message}`,T.classList.remove("hidden")}}let ft=null;function Ta(){const e=document.getElementById("splash-screen");if(!e)return;const t=document.createElement("div");t.id="splash-background-grid";const i=["https://image.tmdb.org/t/p/w500/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg","https://image.tmdb.org/t/p/w500/vseIVRdN4xasYwStQIi6SI7DcEu.jpg","https://image.tmdb.org/t/p/w500/qJ2tW6WMUDux911r6m7haRef0WH.jpg","https://image.tmdb.org/t/p/w500/AgY33Wtg4737MhYopJSFyKWhKsO.jpg","https://image.tmdb.org/t/p/w500/2rNjLWhb9hjv2ZmKAZVItjuJsCP.jpg","https://image.tmdb.org/t/p/w500/8g1aqEKt80x1gbKqc8a1TWb9cr6.jpg","https://image.tmdb.org/t/p/w500/4KAtscEx3Pt9YPpNuK3BO6irQn1.jpg","https://image.tmdb.org/t/p/w500/cVeJ2kQ9qZmpud57iSKsANyAsNp.jpg","https://image.tmdb.org/t/p/w500/hEntfzxB8yUXIxqZY929dELjLsi.jpg","https://image.tmdb.org/t/p/w500/6oom5QYQ2yQTMJIbnvbkBL9cHo6.jpg","https://image.tmdb.org/t/p/w500/46oFAcjORMltwPxR6uU6hM4mN7F.jpg","https://image.tmdb.org/t/p/w500/yh5rAnhNiZz0nkWhbWw98MvdvBH.jpg"];[...i,...i].forEach(a=>{const o=document.createElement("div");o.className="splash-poster",o.style.backgroundImage=`url(${a})`,t.appendChild(o)}),e.prepend(t)}function $a(){const e=document.getElementById("splash-screen"),t=document.getElementById("main-container");t.classList.contains("hidden")&&(console.log("UI is not visible, showing it now..."),t.classList.remove("hidden"),U("my-watched-movies-section"),e.classList.add("fade-out"),e.addEventListener("transitionend",()=>e.style.display="none",{once:!0}))}function Pa(){bi(),wi(),console.log("initializeApp: Starting application..."),Ta(),Ba(),ba(),Vi(),Fn(),xa(),yi();let e=!1;Li(async t=>{if(t){if(t.uid!==ft){ft=t.uid,Ie("Verileriniz yükleniyor...");try{await Promise.all([Ea(t.uid),en(t.uid)]),yt()}catch(i){console.error("Firestore'dan ilk veri yüklenirken hata oluştu:",i)}finally{le()}}e||($a(),e=!0),He(t)}else console.log("Auth state changed. No user found. Signing in anonymously..."),La(),await en(null),yt(),He(null),ft=null,Ii().catch(i=>{})}),document.addEventListener("language-changed",()=>{const t=document.querySelector(".content-section:not(.hidden)");if(t)switch(console.log(`Dil değişti, aktif bölüm yenileniyor: ${t.id}`),t.id){case"profile-section":He(P.currentUser);break;case"my-watched-movies-section":Be();break;case"watch-later-movies-section":Kn();break;default:U(t.id);break}})}document.addEventListener("DOMContentLoaded",Pa);
