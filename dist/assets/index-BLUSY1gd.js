import{getFirestore as ia,doc as Wt,getDoc as oa,deleteDoc as sa,setDoc as ra,collection as en,onSnapshot as tn}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{initializeApp as la}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getAuth as ca,onAuthStateChanged as da,signOut as ma,signInWithEmailAndPassword as ua,EmailAuthProvider as ga,linkWithCredential as pa,createUserWithEmailAndPassword as ha,signInAnonymously as fa}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function a(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=a(i);fetch(i.href,o)}})();let Ve=0,Et=0;const ue=document.body;function va(){Et=window.scrollY,ue.style.position="fixed",ue.style.top=`-${Et}px`,ue.style.width="100%"}function ya(){ue.style.position="",ue.style.top="",ue.style.width="",window.scrollTo(0,Et)}function at(){Ve===0&&va(),Ve++}function it(){Ve--,Ve===0&&ya()}const _a={apiKey:"AIzaSyDAyKiJAWHz1AlTpUSfxXs5LKPU7UhuUYc",authDomain:"sinelog-574c7.firebaseapp.com",projectId:"sinelog-574c7",storageBucket:"sinelog-574c7.appspot.com",messagingSenderId:"59986017154",appId:"1:59986017154:web:b986101e950cb53072ad9b",measurementId:"G-VMLTSMN4MH"},Dn=la(_a),U=ca(Dn),xe=ia(Dn),ba=["510WsOiCBmdTYStLx14ZBvaikro1"];let ie={isPro:!1,plan:null,endDate:null};async function nn(e){if(e&&ba.includes(e)){console.log("👑 Admin kullanıcı algılandı. Tüm özellikler açılıyor."),ie={isPro:!0,plan:"admin",endDate:null};return}if(!e){ie={isPro:!1,plan:null,endDate:null};return}const t=Wt(xe,"users",e),a=await oa(t);if(a.exists()&&a.data().subscription){const n=a.data().subscription,i=n.endDate&&new Date(n.endDate.toMillis())>new Date;n.isPro&&i?ie={isPro:!0,plan:n.plan||null,endDate:n.endDate.toDate()}:ie={isPro:!1,plan:null,endDate:null}}else ie={isPro:!1,plan:null,endDate:null};console.log("User subscription status updated:",ie)}function Ke(){return ie.isPro}function Lt(){const e=document.querySelectorAll(".pro-feature"),t=Ke();e.forEach(a=>{t?a.classList.remove("feature-locked"):a.classList.add("feature-locked")})}let T,an,lt,on,Re="yearly";function wa(){T=document.getElementById("paywall-overlay"),T&&(an=document.getElementById("close-paywall-btn"),lt=document.getElementById("plan-selector"),on=document.getElementById("upgrade-to-pro-btn"),an.addEventListener("click",sn),T.addEventListener("click",e=>{e.target===T&&sn()}),lt.addEventListener("click",e=>{const t=e.target.closest(".plan-option");t&&(lt.querySelectorAll(".plan-option").forEach(a=>a.classList.remove("recommended")),t.classList.add("recommended"),Re=t.dataset.plan,console.log(`Selected plan: ${Re}`))}),on.addEventListener("click",()=>{console.log(`Satın alma işlemi başlatıldı: ${Re}`),alert(`"${Re}" planı için satın alma işlemi başlatılıyor... (Bu henüz gerçek bir ödeme değil)`)}))}function It(){T&&(T.classList.remove("hidden"),setTimeout(()=>T.classList.add("visible"),10))}function sn(){T&&(T.classList.remove("visible"),T.addEventListener("transitionend",()=>{T.classList.contains("visible")||T.classList.add("hidden")},{once:!0}))}let G={},$n="tr";async function qt(e){try{const t=await fetch(`/locales/${e}.json`);if(!t.ok)throw new Error("Dil dosyası yüklenemedi.");G=await t.json(),console.log("Sözlük başarıyla yüklendi. İçinde 'list_top_rated_all_time_name' anahtarı var mı?",G.hasOwnProperty("list_top_rated_all_time_name")),console.log("Yüklenen sözlüğün içeriği:",G),$n=e,Ea(),localStorage.setItem("preferredLanguage",e),console.log(`Dil ${e} olarak ayarlandı.`),document.dispatchEvent(new CustomEvent("language-changed"))}catch(t){console.error(`Dil yüklenirken hata oluştu: ${e}`,t),e!=="tr"&&await qt("tr")}}function Ea(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.dataset.i18n;if(G[t]){const a=e.firstChild;a&&a.nodeType===Node.TEXT_NODE?a.nodeValue=G[t]:e.textContent=G[t]}}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.dataset.i18nPlaceholder;G[t]&&(e.placeholder=G[t])})}function s(e){return G[e]||e}function ne(){return $n}async function La(){const e=localStorage.getItem("preferredLanguage"),t=navigator.language.split("-")[0],a=e||(["en","tr"].includes(t)?t:"tr");await qt(a)}const Fe=document.getElementById("theme-toggle"),rn=document.body,Ia=document.getElementById("theme-status");function ct(e){rn.classList.toggle("light-theme",e==="light"),rn.classList.toggle("dark-theme",e==="dark"),localStorage.setItem("preferredTheme",e),ka(e)}function ka(e){Ia.textContent=s(e==="light"?"theme_light":"theme_dark")}function Ba(){const e=localStorage.getItem("preferredTheme");e?(ct(e),Fe.checked=e==="light"):(ct("dark"),Fe.checked=!1),Fe.addEventListener("change",()=>{ct(Fe.checked?"light":"dark")})}let de,dt,mt,we,Ee;function Ma(){if(de=document.getElementById("settings-overlay"),document.getElementById("settings-panel"),dt=document.getElementById("settings-icon-btn"),mt=document.getElementById("settings-close-btn"),we=document.getElementById("lang-tr-btn"),Ee=document.getElementById("lang-en-btn"),!de||!dt||!mt||!we||!Ee){console.error("Ayarlar menüsü için gerekli HTML elemanları bulunamadı.");return}dt.addEventListener("click",xa),de.addEventListener("click",e=>{e.target===de&&kt()}),mt.addEventListener("click",kt),we.addEventListener("click",()=>ln("tr")),Ee.addEventListener("click",()=>ln("en"))}function xa(){ne()==="tr"?(we.classList.add("active"),Ee.classList.remove("active")):(Ee.classList.add("active"),we.classList.remove("active")),de.classList.add("visible")}function kt(){de.classList.remove("visible")}function ln(e){qt(e),kt()}function Aa(e){da(U,e)}function Sa(){return fa(U)}async function Ca(e,t){const a=U.currentUser;if(a&&a.isAnonymous){const n=ga.credential(e,t);return pa(a,n)}return ha(U,e,t)}function Ta(e,t){return ua(U,e,t)}function Da(){return ma(U)}console.log("utils.js yüklendi.");const $a="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.921-7.417 3.921 1.481-8.279-6.064-5.828 8.332-1.151z",Bt="halfStarGradient";function Pa(e){if(!e)return"";const t=new Date(e),a=new Date,n=new Date(a);if(n.setDate(a.getDate()-1),t.toDateString()===a.toDateString())return s("date_today");if(t.toDateString()===n.toDateString())return s("date_yesterday");{const i=ne()==="tr"?"tr-TR":"en-US",o={year:"numeric",month:"long",day:"numeric"},l=t.toLocaleDateString(i,o);return s("date_on_date").replace("{date}",l)}}function te(e,t="info",a=4e3){const n=document.getElementById("notification-container");if(!n){console.error("Notification container not found!");return}const i=document.createElement("div");i.className=`notification ${t}`,i.textContent=e,n.appendChild(i),setTimeout(()=>{i.classList.add("fade-out"),i.addEventListener("animationend",()=>{i.remove()})},a)}console.log("api.js yüklendi.");const oe="/api/tmdb",Pn="https://image.tmdb.org/t/p/w500",ot="https://image.tmdb.org/t/p/w185",Ae="https://image.tmdb.org/t/p/w92",Ra="https://www.youtube-nocookie.com/embed/";async function Fa(){try{const t=ne()==="tr"?"tr-TR":"en-US",a=`${oe}/trending/movie/week?language=${t}`,n=await fetch(a);if(!n.ok)throw new Error(`Proxy Hatası! Durum: ${n.status}`);const i=await n.json();return i.results?i.results.slice(0,10):[]}catch(e){throw console.error("Trend filmler yüklenirken hata oluştu:",e),e}}async function st(e){try{const a=ne()==="tr"?"tr-TR":"en-US",n=`${oe}/movie/${e}?language=${a}`,i=`${oe}/movie/${e}/credits?language=${a}`,o=`${oe}/movie/${e}/videos?language=en-US`,l=`${oe}/movie/${e}/watch/providers`,r=await fetch(n);if(!r.ok)throw new Error(`Film detayları proxy'den yüklenemedi. HTTP Hata: ${r.status}`);const u=await r.json(),d=await fetch(i);let f="Bilinmiyor",c=[];if(d.ok){const y=await d.json(),M=y.crew.find(w=>w.job==="Director");M&&(f=M.name),c=y.cast.filter(w=>w.known_for_department==="Acting"&&w.profile_path).sort((w,x)=>w.order-x.order).slice(0,10)}else console.warn("Yönetmen/oyuncu bilgisi yüklenemedi. HTTP Hata:",d.status);const m=await fetch(o);let h=null,g=[];if(m.ok){const M=(await m.json()).results.find(w=>w.site==="YouTube"&&w.type==="Trailer"&&w.key);M&&(h=M.key)}else console.warn("Film videoları yüklenemedi. HTTP Hata:",m.status);const v=await fetch(l);if(v.ok){const y=await v.json();y.results&&y.results.TR&&y.results.TR.flatrate&&(g=y.results.TR.flatrate)}else console.warn("Yayın bilgisi yüklenemedi. HTTP Hata:",v.status);return{movieData:u,directorName:f,cast:c,trailerKey:h,watchProviders:g}}catch(t){throw console.error("fetchMovieDetailsFromApi Hatası:",t),t}}async function Ha(e,t,a,n){if(e.length<2){a.textContent="En az 2 karakter giriniz.",a.style.display="block",t.classList.add("hidden"),t.innerHTML="";return}t.innerHTML="",a.style.display="none";try{const o=ne()==="tr"?"tr-TR":"en-US",l=`${oe}/search/movie?query=${encodeURIComponent(e)}&language=${o}`,r=await fetch(l);if(!r.ok)throw new Error(`Proxy Hatası! Durum: ${r.status}`);const u=await r.json();u.results&&u.results.length>0?n(u.results,t):(a.textContent="Film bulunamadı.",a.style.display="block",t.classList.add("hidden"))}catch(i){console.error("TMDB arama sırasında proxy hatası oluştu:",i),a.innerHTML=`
            <p class="text-red-400 font-bold text-base">Arama Hatası!</p>
            <p class="mt-1 text-sm text-gray-400">Film ararken bir sorun oluştu: ${i.message}.</p>
        `,a.style.display="block"}}async function Rn(e){const{type:t,tmdbId:a}=e;try{let n=[];switch(t){case"list":case"collection":case"endpoint":case"director":{let i="";t==="list"?i=`/list/${a}`:t==="collection"?i=`/collection/${a}`:t==="director"?i=`/person/${a}/movie_credits`:i=String(a);const o=i.includes("?")?"&":"?",r=ne()==="tr"?"tr-TR":"en-US",u=`${oe}${i}${o}language=${r}`,d=await fetch(u);if(!d.ok)throw new Error(`HTTP Hatası! Durum: ${d.status}`);const f=await d.json();t==="director"?n=f.crew.filter(c=>c.job==="Director").sort((c,m)=>new Date(m.release_date)-new Date(c.release_date)):n=f.results||f.parts||f.items||[];break}case"manual":{const i=a.map(l=>st(l));n=(await Promise.all(i)).map(l=>l.movieData);break}default:throw new Error("Geçersiz liste tipi")}return n}catch(n){return console.error(`'${e.name}' listesi filmleri çekilirken hata oluştu:`,n),[]}}async function Oa(e,t=!1){try{const a=await fetch("/api/suggest-movie",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e,isRetry:t,lang:ne()})});if(!a.ok){const n=await a.text();try{const i=JSON.parse(n);throw new Error(i.error||`Film önerisi alınırken bir hata oluştu: ${a.status}`)}catch{throw new Error(`Sunucu fonksiyonu bulunamadı veya bir hata oluştu (HTTP ${a.status}).`)}}return await a.json()}catch(a){throw console.error("fetchSuggestedMovie hatası:",a),a}}console.log("rating.js yüklendi.");let E=0;function Mt(e,t=0){console.log("setupStarRating çağrıldı, başlangıç puanı:",t),e.innerHTML="",E=t;for(let a=1;a<=5;a++){const n=document.createElement("span");n.classList.add("star-container"),n.dataset.value=a,n.innerHTML=`
            <svg class="star-svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="${$a}"/>
            </svg>
        `,e.appendChild(n),n.addEventListener("mousemove",i=>{const o=n.getBoundingClientRect(),l=i.clientX-o.left,r=parseFloat(n.dataset.value);l<o.width/2?He(e,r-.5):He(e,r)}),n.addEventListener("mouseleave",()=>{He(e,E)}),n.addEventListener("click",i=>{const o=parseFloat(n.dataset.value);let l;const r=n.getBoundingClientRect();i.clientX-r.left<r.width/2?l=o-.5:l=o,E===l?E===o?E=o-.5:E===o-.5&&(E=o):E=l,E<0&&(E=0),console.log("Yeni puan:",E),cn(e,E),He(e,E)})}cn(e,E)}function cn(e,t){e.querySelectorAll(".star-container").forEach(n=>{const i=parseFloat(n.dataset.value),o=n.querySelector("path");n.classList.remove("selected","selected-half"),t>=i?(n.classList.add("selected"),o.setAttribute("fill","#FFD700")):t===i-.5?(n.classList.add("selected-half"),o.setAttribute("fill",`url(#${Bt})`)):o.setAttribute("fill","#666666")})}function He(e,t){e.querySelectorAll(".star-container").forEach(n=>{const i=parseFloat(n.dataset.value),o=n.querySelector("path");n.classList.remove("hovered","hovered-half"),t>=i?(n.classList.add("hovered"),o.setAttribute("fill","#FFD700")):t===i-.5?(n.classList.add("hovered-half"),o.setAttribute("fill",`url(#${Bt})`)):E>=i?o.setAttribute("fill","#FFD700"):E===i-.5?o.setAttribute("fill",`url(#${Bt})`):o.setAttribute("fill","#666666")})}function ut(e){E=e}async function Fn(e,t){var a;try{const n=await fetch(`/api/gemini${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),i=await n.json();if(!n.ok){const o=((a=i.error)==null?void 0:a.message)||`Proxy hatası: ${n.status}`;throw new Error(o)}return i}catch(n){throw console.error(`Gemini API çağrısı sırasında hata (${e}):`,n),n}}async function Na(e,t,a,n){var i,o,l,r,u;n.classList.add("loading"),n.disabled=!0;try{const f={contents:[{role:"user",parts:[{text:s("gemini_prompt_enhance").replace("{movieTitle}",t).replace("{comment}",e)}]}]},c=await Fn("/gemini-1.5-flash-latest:generateContent",f);if((u=(r=(l=(o=(i=c.candidates)==null?void 0:i[0])==null?void 0:o.content)==null?void 0:l.parts)==null?void 0:r[0])!=null&&u.text)a.value=c.candidates[0].content.parts[0].text,te(s("notification_comment_enhanced"),"success");else throw new Error(s("gemini_error_unexpected_response"))}catch(d){te(s("notification_comment_enhance_fail").replace("{error}",d.message),"error")}finally{n.classList.remove("loading"),n.disabled=!1}}async function ja(e,t,a,n){var u,d,f,c,m,h;const i=s("gemini_prompt_chat_system").replace("{movieTitle}",t).replace("{characterName}",e),o=[];o.push({role:"user",parts:[{text:i}]}),o.push({role:"model",parts:[{text:s("gemini_prompt_chat_ack").replace("{characterName}",e)}]}),a.forEach(g=>o.push({role:g.role,parts:[{text:g.text}]})),o.push({role:"user",parts:[{text:n}]});const r=await Fn("/gemini-1.5-flash-latest:generateContent",{contents:o});if((m=(c=(f=(d=(u=r.candidates)==null?void 0:u[0])==null?void 0:d.content)==null?void 0:f.parts)==null?void 0:c[0])!=null&&m.text)return r.candidates[0].content.parts[0].text;if((h=r.promptFeedback)!=null&&h.blockReason)return s("gemini_error_blocked").replace("{reason}",r.promptFeedback.blockReason);throw new Error(s("gemini_error_no_response"))}let Q,gt,W,le,Z,pt,Hn,On,Le,ht,Ie,xt,Yt={tmdbId:null,title:null},X=null,me=[];const dn=10;let mn=!1;function Nn(){mn||(Q=document.getElementById("character-selection-modal"),gt=document.getElementById("close-character-selection-modal-btn"),W=document.getElementById("character-list-container"),le=document.getElementById("character-list-loader"),Z=document.getElementById("chat-interface-modal"),pt=document.getElementById("close-chat-interface-modal-btn"),Hn=document.getElementById("chat-header-character-avatar"),On=document.getElementById("chat-header-character-name"),Le=document.getElementById("chat-messages-container"),ht=document.getElementById("chat-form"),Ie=document.getElementById("chat-message-input"),xt=document.getElementById("chat-send-btn"),gt&&gt.addEventListener("click",At),Q&&Q.addEventListener("click",e=>{e.target===Q&&At()}),pt&&pt.addEventListener("click",un),Z&&Z.addEventListener("click",e=>{e.target===Z&&un()}),ht&&ht.addEventListener("submit",za),mn=!0)}function Ua(e){if(W.replaceChildren(),!e||e.length===0){const t=document.createElement("p");t.className="text-center text-gray-500",t.textContent=s("character_no_character_found"),W.appendChild(t);return}e.forEach(t=>{const a=document.createElement("div");a.className="character-item";const n=document.createElement("img");n.className="character-avatar",n.alt=t.name,n.src=t.profile_path?`${ot}${t.profile_path}`:"https://placehold.co/60x60/2d333b/8b949e?text=?",n.addEventListener("error",()=>{n.src="https://placehold.co/60x60/2d333b/8b949e?text=?"},{once:!0});const i=document.createElement("div");i.className="character-info";const o=document.createElement("div");o.className="character-name",o.textContent=t.character||t.name;const l=document.createElement("div");l.className="character-actor",l.textContent=t.name,i.append(o,l),a.append(n,i),a.addEventListener("click",()=>qa(t)),W.appendChild(a)})}function Ga(){Nn();const e=document.getElementById("movie-tmdb-id").value,t=document.getElementById("movie-title-input").value;if(!e){te("Sohbet için filmin TMDB verisi gerekli.","error");return}Wa({id:e,title:t})}async function Wa(e){Yt=e,Q.classList.remove("hidden"),setTimeout(()=>Q.classList.add("visible"),10),document.body.classList.add("no-scroll"),W.classList.add("hidden"),le.classList.remove("hidden"),le.classList.add("visible");const t=le.querySelector("dotlottie-player");t&&t.play();try{const{cast:a}=await st(e.id),n=a.filter(i=>i.known_for_department==="Acting"&&i.profile_path).sort((i,o)=>i.order-o.order).slice(0,10);Ua(n),W.classList.remove("hidden")}catch(a){console.error("Karakterler alınırken hata:",a),W.replaceChildren();const n=document.createElement("p");n.className="text-red-400 text-center",n.textContent=s("character_loading_error"),W.appendChild(n),W.classList.remove("hidden")}finally{t&&t.stop(),le.classList.add("hidden"),le.classList.remove("visible")}}function At(){Q.classList.remove("visible"),Z.classList.contains("visible")||document.body.classList.remove("no-scroll")}function qa(e){X=e,At(),Ya()}function Ya(){me=[],Le.innerHTML="",Ie.value="";const e=X.character||X.name;On.textContent=e,Hn.src=X.profile_path?ot+X.profile_path:"https://placehold.co/60x60/2A2A2A/AAAAAA?text=?",Z.classList.remove("hidden"),setTimeout(()=>Z.classList.add("visible"),10),document.body.classList.add("no-scroll");const t=s("chat_welcome").replace("{characterName}",e);St("model",t)}function un(){Z.classList.remove("visible"),Q.classList.contains("visible")||document.body.classList.remove("no-scroll"),X=null,Yt={tmdbId:null,title:null}}async function za(e){e.preventDefault();const t=Ie.value.trim();if(!t)return;St("user",t),gn({role:"user",text:t}),Ie.value="";const a=St("model","",!0);xt.disabled=!0;try{const n=await ja(X.character||X.name,Yt.title,me,t);a.innerHTML=n,a.classList.remove("thinking"),gn({role:"model",text:n})}catch(n){a.innerHTML=s("chat_error_generic").replace("{error}",n.message),a.classList.remove("thinking")}finally{xt.disabled=!1,Ie.focus()}}function St(e,t,a=!1){const n=document.createElement("div");n.className=`chat-message ${e}`;const i=document.createElement("div");return i.className="message-bubble",a?(i.classList.add("thinking"),i.innerHTML="<span></span><span></span><span></span>"):i.textContent=t,n.appendChild(i),Le.appendChild(n),Le.scrollTop=Le.scrollHeight,i}function gn(e){me.push(e),me.length>dn&&me.splice(0,me.length-dn)}let F,be,ge,pe,Se,H,Je,ee,q,he,I,ke,K,se,Qe,Ct,Ze,Xe,et,P,Oe,ft,Ne,pn,hn,fn,vn,vt,yt,Ge,z,Tt,yn=!1;function Va(){if(yn)return;const e=document.getElementById("movie-modal-overlay");if(!e)return;const t=document.createElement("div");t.className="modal-content",t.innerHTML=`
    <div class="modal-header"><h2 id="modal-title"></h2></div>
    <form id="movie-form" novalidate>
        <input type="hidden" id="movie-id" /><input type="hidden" id="movie-tmdb-id" /><input type="hidden" id="movie-type" /><input type="hidden" id="movie-runtime-input" /><input type="hidden" id="movie-genres-input" /><input type="hidden" id="movie-director-input" />
        <div class="form-group">
            <label for="movie-title-input" data-i18n="modal_movie_title_label">${s("modal_movie_title_label")}</label>
            <input type="text" id="movie-title-input" required placeholder="${s("placeholder_movie_title")}" />
            <div id="tmdb-search-results" class="tmdb-search-results hidden"></div>
            <p id="tmdb-search-message" class="tmdb-search-message" style="display: none;"></p>
        </div>
        <input type="hidden" id="movie-poster-input" />
        <div class="form-group"><label for="movie-rating-input" data-i18n="modal_rating_label">${s("modal_rating_label")}</label><div id="movie-rating-input" class="rating-input"></div></div>
        <label class="toggle-switch-container"><span class="toggle-switch-label" data-i18n="modal_watch_later_label">${s("modal_watch_later_label")}</span><div class="toggle-switch-wrapper"><input type="checkbox" id="watch-later-checkbox" /><span class="toggle-switch-slider"></span></div></label>
        <div class="form-group" id="watched-date-group"><label for="movie-date-input" data-i18n="modal_watched_date_label">${s("modal_watched_date_label")}</label><input type="date" id="movie-date-input" value="" required /></div>
        <div class="form-group">
            <label for="movie-comment-input" data-i18n="modal_comment_label">${s("modal_comment_label")}</label>
            <textarea id="movie-comment-input" rows="3" data-i18n-placeholder="ai_prompt_modal_placeholder" placeholder="${s("ai_prompt_modal_placeholder")}"></textarea>
            <div class="form-buttons-group">
                <button type="button" id="enhance-comment-button" class="enhance-comment-button pro-feature"><span class="loading-spinner"></span><span class="button-text" data-i18n="modal_enhance_comment_button">${s("modal_enhance_comment_button")}<span class="pro-badge">PRO</span></span></button>
                <button type="button" id="chat-with-character-button" class="chat-character-button hidden pro-feature"><span class="loading-spinner"></span><span class="button-text" data-i18n="modal_chat_button">${s("modal_chat_button")}<span class="pro-badge">PRO</span></span></button>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" id="cancel-button" class="cancel-button" data-i18n="modal_cancel_button">${s("modal_cancel_button")}</button>
            <button type="submit" id="save-button" class="save-button" data-i18n="modal_save_button">${s("modal_save_button")}</button>
        </div>
    </form>
`,e.appendChild(t),F=e,be=document.getElementById("modal-title"),ge=document.getElementById("movie-id"),pe=document.getElementById("movie-tmdb-id"),Se=document.getElementById("movie-type"),H=document.getElementById("movie-title-input"),Je=document.getElementById("movie-poster-input"),ee=document.getElementById("movie-rating-input"),q=document.getElementById("watch-later-checkbox"),he=document.getElementById("watched-date-group"),I=document.getElementById("movie-date-input"),ke=document.getElementById("movie-comment-input"),K=document.getElementById("enhance-comment-button"),se=document.getElementById("chat-with-character-button"),Qe=document.getElementById("tmdb-search-results"),Ct=document.getElementById("tmdb-search-message"),Ze=document.getElementById("movie-runtime-input"),Xe=document.getElementById("movie-genres-input"),et=document.getElementById("movie-director-input"),Tt=document.getElementById("movie-form"),Tt.addEventListener("submit",Ka),document.getElementById("cancel-button").addEventListener("click",()=>Dt()),F.addEventListener("click",n=>{n.target===F&&Dt()});let a;q.addEventListener("change",()=>{const n=ee.parentElement,i=!!pe.value;q.checked?(I.disabled=!0,I.required=!1,he.style.display="none",n.style.display="none",ee.innerHTML="",K.style.display="none",se.classList.add("hidden")):(I.disabled=!1,I.required=!0,he.style.display="block",n.style.display="block",Mt(ee,0),K.style.display="block",i&&se.classList.remove("hidden"))}),H.addEventListener("input",()=>{H.readOnly||(clearTimeout(a),a=setTimeout(()=>{Ha(H.value,Qe,Ct,ii)},300))}),K.addEventListener("click",async()=>{if(!Ke()){It();return}const n=ke.value.trim();if(n.length<10){te(s("notification_save_validation_fail"),"error");return}await Na(n,H.value,ke,K)}),se.addEventListener("click",()=>{if(!Ke()){It();return}Ga()}),yn=!0}function $e(e=null,t=null,a=null){at(),Va();const n=new Date().toISOString().split("T")[0];I.max=n,Tt.reset(),ut(0),Qe.innerHTML="",Qe.classList.add("hidden"),Ct.style.display="none",H.readOnly=!1,se.classList.add("hidden");const i=ee.parentElement;if(e){let r,u=a==="watch-later";u?r=Pe.find(d=>d.id===e):r=ve.find(d=>d.id===e),r&&(be.dataset.i18n="modal_edit_title",be.textContent=s("modal_edit_title"),ge.value=r.id,pe.value=r.tmdbId||"",Se.value=a,Ze.value=r.runtime||"",H.value=r.title,Je.value=r.poster,ke.value=r.comment||"",Xe.value=JSON.stringify(r.genres||[]),et.value=r.director||"",q.checked=u,u?(I.disabled=!0,I.required=!1,he.style.display="none",i.style.display="none",K.style.display="none",ut(0),ee.innerHTML=""):(I.disabled=!1,I.required=!0,he.style.display="block",i.style.display="block",K.style.display="block",I.value=r.watchedDate||"",ut(r.rating||0),Mt(ee,r.rating||0)))}else be.dataset.i18n="modal_add_title",be.textContent=s("modal_add_title"),ge.value="",Se.value="watched",I.value=n,q.checked=!1,I.disabled=!1,I.required=!0,he.style.display="block",i.style.display="block",K.style.display="block",Mt(ee,0),t&&(H.value=t.title||"",Je.value=t.poster||"",Ze.value=t.runtime||"",Xe.value=JSON.stringify(t.genres||[]),et.value=t.director||"",pe.value=t.tmdbId||"",t.release_date&&(I.value=t.release_date),H.readOnly=!0);const o=!!pe.value,l=q.checked;o&&!l?se.classList.remove("hidden"):se.classList.add("hidden"),Lt(),F.classList.remove("hidden"),setTimeout(()=>F.classList.add("visible"),10)}function Dt(){F&&(it(),F.classList.remove("visible"),F.addEventListener("transitionend",()=>{F.classList.contains("visible")||F.classList.add("hidden")},{once:!0}))}async function zt(e,t=!1){var l;at(),P||(P=document.getElementById("movie-details-modal-overlay"),Oe=document.getElementById("detail-modal-title"),ft=document.getElementById("detail-modal-body"),Ne=document.getElementById("detail-lottie-loader"),pn=document.getElementById("detail-movie-poster"),hn=document.getElementById("detail-movie-release-date"),fn=document.getElementById("detail-movie-genres"),vn=document.getElementById("detail-movie-director"),vt=document.getElementById("detail-movie-overview"),yt=document.getElementById("detail-movie-trailer-section"),Ge=document.getElementById("detail-movie-trailer-iframe"),z=document.getElementById("detail-add-to-log-button")),t&&P.classList.add("is-layered"),P.classList.remove("hidden"),setTimeout(()=>P.classList.add("visible"),10),ft.style.display="none",Ne.style.display="flex";const a=Ne.querySelector("dotlottie-player");a&&a.play(),Oe.textContent=s("loading"),z.disabled=!0;const n=document.getElementById("detail-movie-cast"),i=new Promise(r=>setTimeout(r,500)),o=st(e);try{const[r,u]=await Promise.all([i,o]),{movieData:d,directorName:f,cast:c,trailerKey:m,watchProviders:h}=u;if(Oe.textContent=d.title||s("details_no_info"),pn.src=d.poster_path?`${Pn}${d.poster_path}`:"https://placehold.co/112x160/2A2A2A/AAAAAA?text=Poster+Yok",hn.textContent=`${s("details_release_date_prefix")}: ${d.release_date?new Date(d.release_date).toLocaleDateString(ne()==="tr"?"tr-TR":"en-US",{year:"numeric",month:"long",day:"numeric"}):s("details_no_info")}`,fn.textContent=`${s("details_genres_prefix")}: ${((l=d.genres)==null?void 0:l.length)>0?d.genres.map(b=>b.name).join(", "):s("details_no_info")}`,vn.textContent=`${s("details_director_prefix")}: ${f}`,c&&c.length>0){const b=c.slice(0,5).map(A=>A.name).join(", ");n.textContent=`${s("details_cast_prefix")}: ${b}`,n.style.display="block"}else n.style.display="none";vt.textContent=d.overview||s("details_no_overview");const g=document.getElementById("detail-tmdb-rating"),v=document.getElementById("detail-imdb-link"),y=document.getElementById("detail-ratings-container");d.vote_average?g.textContent=d.vote_average.toFixed(1):g.textContent="N/A",d.imdb_id?(v.href=`https://www.imdb.com/title/${d.imdb_id}/`,v.style.display="inline-flex"):v.style.display="none",y.style.display="flex",m?(Ge.src=`${Ra}${m}?rel=0`,yt.classList.remove("hidden")):(Ge.src="",yt.classList.add("hidden"));const M=document.getElementById("detail-watch-providers-section"),w=document.getElementById("detail-watch-providers-grid");w.innerHTML="",h&&h.length>0?(M.classList.remove("hidden"),h.forEach(b=>{const A=document.createElement("img");A.className="provider-logo-img",A.src=`${Ae}${b.logo_path}`,A.alt=b.provider_name,A.title=b.provider_name,w.appendChild(A)})):M.classList.add("hidden");const x=z.cloneNode(!0);z.parentNode.replaceChild(x,z),z=x,z.addEventListener("click",()=>{$t();const b=document.getElementById("suggestionResultOverlay");b&&b.classList.contains("visible")&&b.classList.remove("visible"),$e(null,{title:d.title,tmdbId:d.id,poster:d.poster_path?Ae+d.poster_path:"",release_date:d.release_date,runtime:d.runtime,genres:d.genres,director:f})}),z.disabled=!1}catch(r){console.error("Film detayları yüklenirken hata oluştu:",r),Oe.textContent=s("error_occurred_title"),vt.textContent=s("details_error_loading").replace("{error}",r.message)}finally{a&&a.stop(),Ne.style.display="none",ft.style.display="flex"}}function $t(){P&&(it(),P.classList.remove("visible"),Ge.src="",P.addEventListener("transitionend",()=>{P.classList.contains("visible")||(P.classList.add("hidden"),P.classList.remove("is-layered"))},{once:!0}))}async function Ka(e){e.preventDefault(),Dt();const t={id:ge.value||Date.now().toString(),tmdbId:pe.value,title:H.value.trim(),poster:Je.value||"https://placehold.co/70x100/2A2A2A/AAAAAA?text=Poster+Yok",comment:ke.value,type:q.checked?"watch-later":"watched",runtime:parseInt(Ze.value,10)||0,director:et.value||s("unknown"),genres:JSON.parse(Xe.value||"[]"),rating:q.checked?null:E,watchedDate:q.checked?null:I.value};if(t.type==="watched"&&(t.rating===0||!t.watchedDate)){te(s("notification_save_validation_fail"),"error");return}ge.value&&Se.value!==t.type&&await Ci(ge.value,Se.value),await Si(t),te(s("notification_movie_saved").replace("{title}",t.title),"success")}document.getElementById("loadingSpinnerOverlay");const tt=document.querySelector(".particles-container");let Be;const _n=["https://image.tmdb.org/t/p/w92/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg","https://image.tmdb.org/t/p/w92/rBF8wVQN8hTwsGPgWbARNIJyEj.jpg","https://image.tmdb.org/t/p/w92/qJ2tW6WMUDux911r6m7haRef0WH.jpg","https://image.tmdb.org/t/p/w92/2u7zbn8EudG6kLlJXPv2DEqv6H.jpg","https://image.tmdb.org/t/p/w92/suaEOtk1N1sgg2MTM7oZd2cfVp3.jpg","https://image.tmdb.org/t/p/w92/8OKmBV5BUFzmozIC3pPWKHy17kx.jpg","https://image.tmdb.org/t/p/w92/d5iIlFn5s0ImszYzrKYOFT0Rdl2.jpg","https://image.tmdb.org/t/p/w92/bX2xnavhMYjWDoZp1VM6VnU1xwe.jpg"];function Ja(){if(!tt)return;const e=document.createElement("div");e.className="particle";const t=Math.random()*40+10,a=Math.random()*100,n=Math.random()*10+8,i=Math.random()*5,o=_n[Math.floor(Math.random()*_n.length)];e.style.width=`${t}px`,e.style.height=`${t}px`,e.style.left=`${a}%`,e.style.animationDuration=`${n}s`,e.style.animationDelay=`${i}s`,e.style.backgroundImage=`url(${o})`,tt.appendChild(e),setTimeout(()=>{e.remove()},(n+i)*1e3)}function Qa(){Be&&clearInterval(Be),tt&&(tt.innerHTML=""),Be=setInterval(Ja,200)}function Za(){Be&&clearInterval(Be)}function Ce(e){const t=document.getElementById("loadingSpinnerOverlay");if(!t)return;const a=t.querySelector("dotlottie-player"),n=s("loading_texts"),i=e||(Array.isArray(n)?n[Math.floor(Math.random()*n.length)]:s("loading"));document.getElementById("splash-text").textContent=i,t.classList.remove("hidden"),setTimeout(()=>{t.classList.add("visible"),Qa(),a&&a.play()},10)}function fe(){const e=document.getElementById("loadingSpinnerOverlay");if(!e)return;const t=e.querySelector("dotlottie-player");t&&t.stop(),e.classList.remove("visible"),Za(),e.addEventListener("transitionend",()=>{e.classList.contains("visible")||e.classList.add("hidden")},{once:!0})}const Te=[{id:"first_step",name:"badge_first_step_name",icon:"🚀",description:"badge_first_step_desc",condition:e=>e.totalMovies>=1},{id:"curious_viewer",name:"badge_curious_viewer_name",icon:"🧐",description:"badge_curious_viewer_desc",condition:e=>e.totalMovies>=10},{id:"cinephile",name:"badge_cinephile_name",icon:"📚",description:"badge_cinephile_desc",condition:e=>e.totalMovies>=50},{id:"film_gourmet",name:"badge_film_gourmet_name",icon:"🧑‍🍳",description:"badge_film_gourmet_desc",condition:e=>e.totalMovies>=100},{id:"pandaflicks_elite",name:"badge_pandaflicks_elite_name",icon:"👑",description:"badge_pandaflicks_elite_desc",condition:e=>e.totalMovies>=250},{id:"short_film_collector",name:"badge_short_film_collector_name",icon:"🎬",description:"badge_short_film_collector_desc",condition:e=>e.shortFilmCount>=5},{id:"marathoner",name:"badge_marathoner_name",icon:"🏃‍♂️",description:"badge_marathoner_desc",condition:e=>e.hasMarathonMovie},{id:"epic_viewer",name:"badge_epic_viewer_name",icon:"🗿",description:"badge_epic_viewer_desc",condition:e=>e.hasEpicMovie},{id:"one_day_filmgoer",name:"badge_one_day_filmgoer_name",icon:"🗓️",description:"badge_one_day_filmgoer_desc",condition:e=>e.totalRuntimeMinutes>=1440},{id:"10_day_filmgoer",name:"badge_10_day_filmgoer_name",icon:"🎖️",description:"badge_10_day_filmgoer_desc",condition:e=>e.totalRuntimeMinutes>=14400},{id:"critic",name:"badge_critic_name",icon:"✍️",description:"badge_critic_desc",condition:e=>e.commentedMoviesCount>=25},{id:"master_commentator",name:"badge_master_commentator_name",icon:"✒️",description:"badge_master_commentator_desc",condition:e=>e.commentedMoviesCount>=100},{id:"perfectionist",name:"badge_perfectionist_name",icon:"🌟",description:"badge_perfectionist_desc",condition:e=>e.fiveStarCount>=5},{id:"hard_to_please",name:"badge_hard_to_please_name",icon:"🤨",description:"badge_hard_to_please_desc",condition:e=>e.oneStarCount>=5},{id:"perfect_streak",name:"badge_perfect_streak_name",icon:"✨",description:"badge_perfect_streak_desc",condition:e=>e.perfectStreakCount>=3},{id:"genre_enthusiast",name:"badge_genre_enthusiast_name",icon:"🎭",description:"badge_genre_enthusiast_desc",condition:e=>e.maxFilmsInSingleGenre>=15},{id:"genre_expert",name:"badge_genre_expert_name",icon:"🎓",description:"badge_genre_expert_desc",condition:e=>e.maxFilmsInSingleGenre>=50},{id:"rainbow_palette",name:"badge_rainbow_palette_name",icon:"🎨",description:"badge_rainbow_palette_desc",condition:e=>e.uniqueGenreCount>=7},{id:"director_fan",name:"badge_director_fan_name",icon:"🏆",description:"badge_director_fan_desc",condition:e=>e.maxFilmsFromSingleDirector>=5},{id:"director_follower",name:"badge_director_follower_name",icon:"🎥",description:"badge_director_follower_desc",condition:e=>e.maxFilmsFromSingleDirector>=10},{id:"80s_kid",name:"badge_80s_kid_name",icon:"🕹️",description:"badge_80s_kid_desc",condition:e=>e.count80sFilms>=10},{id:"90s_spirit",name:"badge_90s_spirit_name",icon:"📼",description:"badge_90s_spirit_desc",condition:e=>e.count90sFilms>=15},{id:"millennium_cinephile",name:"badge_millennium_cinephile_name",icon:"💽",description:"badge_millennium_cinephile_desc",condition:e=>e.count00sFilms>=20},{id:"classic_master",name:"badge_classic_master_name",icon:"🎞️",description:"badge_classic_master_desc",condition:e=>e.countPre70sFilms>=10},{id:"documentary_buff",name:"badge_documentary_buff_name",icon:"🌍",description:"badge_documentary_buff_desc",condition:e=>e.documentaryCount>=5},{id:"weekend_warrior",name:"badge_weekend_warrior_name",icon:"🍿",description:"badge_weekend_warrior_desc",condition:e=>e.maxMoviesInWeekend>=5},{id:"double_feature",name:"badge_double_feature_name",icon:"✌️",description:"badge_double_feature_desc",condition:e=>e.maxMoviesInDay>=2},{id:"loyal_friend",name:"badge_loyal_friend_name",icon:"🤝",description:"badge_loyal_friend_desc",condition:e=>e.accountAgeInDays>=365},{id:"animator",name:"badge_animator_name",icon:"🦄",description:"badge_animator_desc",condition:e=>e.animationCount>=5},{id:"collector",name:"badge_collector_name",icon:"💎",description:"badge_collector_desc",condition:(e,t)=>t.length>=15}];function Xa(e){let t=Te.filter(n=>n.id==="collector"?!1:n.condition(e));const a=Te.find(n=>n.id==="collector");return a&&a.condition(e,t)&&t.push(a),t}let B,jn,Un,Gn,_t;function ei(){if(B=document.getElementById("badge-info-modal"),B==null||B.querySelector(".micro-modal-content"),jn=document.getElementById("badge-info-icon"),Un=document.getElementById("badge-info-name"),Gn=document.getElementById("badge-info-description"),_t=document.getElementById("badge-info-close-btn"),!B||!_t){console.error("Rozet bilgi modalı DOM elementleri bulunamadı.");return}_t.addEventListener("click",bn),B.addEventListener("click",e=>{e.target===B&&bn()})}function ti(e){!e||!B||(jn.textContent=e.icon,Un.textContent=s(e.name),Gn.textContent=s(e.description),B.classList.remove("hidden"),setTimeout(()=>{B.classList.add("visible")},10))}function bn(){B&&(B.classList.remove("visible"),B.addEventListener("transitionend",()=>{B.classList.contains("visible")||B.classList.add("hidden")},{once:!0}))}function Wn(e){let t='<span class="flex items-center">';const a="M12 .587l3.668 7.568 8.332 1.151-6.064 5.828 1.48 8.279-7.416-3.921-7.417 3.921 1.481-8.279-6.064-5.828 8.332-1.151z",n="halfStarGradient";for(let i=1;i<=5;i++){let o;e>=i?o="var(--accent-secondary)":e===i-.5?o=`url(#${n})`:o="#484f58",t+=`<svg class="star-display-svg" viewBox="0 0 24 24" width="1.1em" height="1.1em" fill="${o}"><path d="${a}"/></svg>`}return t+="</span>",t}function ni(e,t,a,n){if(e.replaceChildren(),t.length===0){a.style.display="block";return}a.style.display="none",t.forEach(i=>{const o=document.createElement("div");o.className="movie-item";const l=document.createElement("img");l.className="movie-poster",l.src=i.poster||"fallback-image.png",l.alt=`${i.title} Poster`,l.addEventListener("error",()=>{l.src="https://placehold.co/70x100/2A2A2A/AAAAAA?text=Poster+Yok"},{once:!0});const r=document.createElement("div");r.className="movie-details";const u=document.createElement("div");u.className="movie-title",u.textContent=i.title;const d=document.createElement("div");d.innerHTML=Wn(i.rating);const f=document.createElement("div");if(f.className="watched-date",f.textContent=Pa(i.watchedDate),r.append(u,d,f),i.comment){const m=document.createElement("p");m.className="short-comment",m.textContent=i.comment,m.addEventListener("click",h=>{h.stopPropagation(),m.classList.toggle("expanded")}),r.appendChild(m)}const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("fill","none"),c.setAttribute("viewBox","0 0 24 24"),c.setAttribute("stroke-width","2.5"),c.setAttribute("stroke","currentColor"),c.classList.add("w-5","h-5","text-gray-400","self-center","ml-2"),c.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />',o.append(l,r,c),o.addEventListener("click",()=>{n(i.id,null,"watched")}),e.appendChild(o)})}function qn(e,t,a,n){if(e.innerHTML="",t.length===0){a.style.display="block";return}a.style.display="none",t.forEach(i=>{const o=document.createElement("div");o.classList.add("movie-item"),o.innerHTML=`
            <img src="${i.poster}" alt="${i.title} Poster" class="movie-poster" onerror="this.onerror=null;this.src='https://placehold.co/70x100/2A2A2A/AAAAAA?text=Poster+Yok';">
            <div class="movie-details">
                <div class="movie-title">${i.title}</div>
                <p class="short-comment">${s("watch_later_status")}</p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 text-gray-400 self-center ml-2"><path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" /></svg>
        `,o.addEventListener("click",()=>{n(i.id,null,"watch-later")}),e.appendChild(o)})}function ai(e,t){const a=document.getElementById("trending-movies-grid");a.innerHTML="",e.forEach(n=>{const i=document.createElement("div");i.classList.add("trending-item"),i.innerHTML=`<img src="${n.poster_path?ot+n.poster_path:"https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok"}" alt="${n.title}" class="trending-poster" onerror="this.onerror=null;this.src='https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok';"><div class="trending-title">${n.title}</div>`,i.addEventListener("click",()=>t(n.id)),a.appendChild(i)})}function ii(e,t){t.innerHTML="",t.classList.remove("hidden"),e.slice(0,5).forEach(a=>{const n=document.createElement("div");n.classList.add("tmdb-result-item"),n.innerHTML=`<img src="${a.poster_path?Ae+a.poster_path:"https://placehold.co/40x60/2A2A2A/AAAAAA?text=Yok"}" alt="${a.title}" class="tmdb-result-poster"><div class="tmdb-result-details"><div class="tmdb-result-title">${a.title}</div><div class="tmdb-result-year">${a.release_date?a.release_date.substring(0,4):""}</div></div>`,n.addEventListener("click",async()=>{const i=document.getElementById("movie-title-input"),o=document.getElementById("movie-poster-input"),l=document.getElementById("movie-date-input"),r=document.getElementById("movie-runtime-input"),u=document.getElementById("movie-genres-input"),d=document.getElementById("movie-director-input"),f=document.getElementById("movie-tmdb-id"),c=document.getElementById("chat-with-character-button"),m=document.getElementById("watch-later-checkbox"),h=document.getElementById("tmdb-search-message");h.textContent=`'${a.title}' detayları yükleniyor...`,h.style.display="block",t.classList.add("hidden");try{const{movieData:g,directorName:v}=await st(a.id);i.value=g.title,o.value=g.poster_path?Ae+g.poster_path:"",r.value=g.runtime||0,u.value=JSON.stringify(g.genres||[]),d.value=v||"Bilinmiyor",f.value=a.id,l.value||(l.value=g.release_date||new Date().toISOString().split("T")[0]),h.style.display="none",i.readOnly=!0,m.checked||c.classList.remove("hidden")}catch(g){console.error("Arama sonucundan detay çekerken hata:",g),h.textContent=s("error_loading_details").replace("{error}",g.message)}}),t.appendChild(n)})}function oi(e){const t=document.getElementById("profile-hero"),a=document.getElementById("cinematic-identity-badge"),n=document.getElementById("profile-stats-panel");if(!t||!a||!n)return;if(e.topRatedMovie&&e.topRatedMovie.poster){const c=e.topRatedMovie.poster.replace(Ae,"");t.style.backgroundImage=`url(${Pn}${c})`}else t.style.backgroundImage="none";if(a.textContent=e.cinematicIdentity,n.innerHTML="",e.totalMovies===0){n.innerHTML=`<p class="text-gray-400 text-center col-span-full p-4">${s("profile_empty_message")}</p>`;return}let i="";const o=[{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',value:e.totalMovies,label:s("stat_total_movies")},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',value:e.avgRating.toFixed(1),label:s("stat_avg_rating")},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',value:e.totalWatchTime,label:s("stat_total_time")}];let l='<div class="stat-group" style="--animation-delay: 0ms;"><div class="overview-grid">';o.forEach(c=>{l+=`<div class="overview-card"><div class="overview-icon">${c.icon}</div><div class="overview-text"><span class="overview-value">${c.value}</span><span class="overview-label">${c.label}</span></div></div>`}),l+="</div></div>",i+=l;const r=Object.values(e.ratingDistribution).reduce((c,m)=>c+m,0);if(r>0){let c=`<div class="stat-group" style="--animation-delay: 200ms;"><h3 class="stat-group-title">${s("stat_rating_dist")}</h3><ul class="stat-list">`;Object.keys(e.ratingDistribution).sort((h,g)=>parseFloat(g)-parseFloat(h)).forEach(h=>{const g=e.ratingDistribution[h],v=g/r*100;c+=`<li class="rating-bar-container" data-rating="${h}"><div class="rating-bar-label">${Wn(parseFloat(h))}</div><div class="rating-bar"><div class="rating-bar-fill" style="width: 0%;" data-width="${v}%"></div></div><span class="rating-bar-count">${g}</span></li>`}),c+="</ul></div>",i+=c}if(e.badges){const{all:c,earned:m}=e.badges,h=new Set(m.map(v=>v.id));let g=`<div class="stat-group" style="--animation-delay: 300ms;"><div class="badge-group-header"><h3 class="stat-group-title">${s("stat_badge_collection")}</h3><span class="badge-count">${m.length} / ${c.length}</span></div>`;if(m.length>0){const v=m[m.length-1];g+=`<div class="badge-showcase" data-badge-id="${v.id}"><div class="featured-badge"><div class="featured-badge-icon">${v.icon}</div><span class="featured-badge-name">${s(v.name)}</span><span class="featured-badge-label">${s("stat_latest_badge")}</span></div><div class="other-badges">`,m.slice(-5,-1).reverse().forEach(y=>{g+=`<div class="badge-icon-preview" title="${s(y.name)}" data-badge-id="${y.id}">${y.icon}</div>`}),g+="</div></div>"}g+='<div id="badge-collection-grid" class="badge-collection-grid">',c.forEach(v=>{const y=h.has(v.id);g+=`<div class="badge-card ${y?"earned":"locked"}" data-badge-id="${v.id}"><div class="badge-icon">${v.icon}</div><div class="badge-text"><span class="badge-name">${s(v.name)}</span>${y?"":`<span class="badge-locked-text">${s("badge_locked")}</span>`}</div></div>`}),g+="</div>",c.length>0&&(g+=`<button id="toggle-badges-btn" class="toggle-badges-btn">${s("stat_view_collection")}</button>`),g+="</div>",i+=g}n.innerHTML=i;const u=document.getElementById("profile-stats-panel");u&&u.addEventListener("click",c=>{const m=c.target.closest(".badge-card, .featured-badge, .badge-icon-preview");if(m){const h=m.dataset.badgeId,g=Te.find(v=>v.id===h);g&&ti(g)}});const d=document.getElementById("toggle-badges-btn"),f=document.getElementById("badge-collection-grid");d&&f&&d.addEventListener("click",()=>{f.classList.toggle("expanded"),d.textContent=f.classList.contains("expanded")?s("stat_hide_collection"):s("stat_view_collection")}),setTimeout(()=>{document.querySelectorAll(".rating-bar-fill").forEach(c=>c.style.width=c.dataset.width)},100)}function si(e,t,a){e.innerHTML=`<h2 class="text-xl font-bold mb-4 text-gray-200">${s("special_lists_title")}</h2>`;const n=document.createElement("div");n.className="special-lists-container",t.forEach((i,o)=>{const l=document.createElement("div");l.className="list-card-v3",l.style.setProperty("--animation-delay",`${o*80}ms`);const r=i.heroImage||"https://placehold.co/300x450/161b22/8b949e?text=PandaFlicks";l.innerHTML=`
            <div class="list-card-image-wrapper">
                <div class="list-card-bg-image" style="background-image: url(${r})"></div>
                
                <img src="${r}" alt="${i.name}" class="list-card-fg-image" onerror="this.style.display='none'">
            </div>
            <div class="list-card-text-content">
                <div>
                    <h3 class="list-card-title">${s(i.name)}</h3>
                    <p class="list-card-description">${s(i.description)}</p>
                </div>
                <div class="list-card-chevron">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </div>
            </div>
        `,l.addEventListener("click",()=>a(i)),n.appendChild(l)}),e.appendChild(n)}function ri(e,t,a){if(e.innerHTML="",t.length===0){e.innerHTML=`<p class="text-gray-500 text-center col-span-full">${s("list_empty_message")}</p>`;return}t.forEach(n=>{const i=document.createElement("div");i.classList.add("trending-item"),i.innerHTML=`<img src="${n.poster_path?ot+n.poster_path:"https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok"}" alt="${n.title}" class="trending-poster" onerror="this.onerror=null;this.src='https://placehold.co/80x120/2A2A2A/AAAAAA?text=Poster+Yok';"><div class="trending-title">${n.title}</div>`,i.addEventListener("click",()=>a(n.id)),e.appendChild(i)})}function li(e){if(e===0)return s("time_zero_minutes");const t=Math.floor(e/60),a=e%60;let n="";return t>0&&(n+=`${t} ${s("time_hours")} `),a>0&&(n+=`${a} ${s("time_minutes")}`),n.trim()}function ci(e){if(e.totalMovies<5)return s("identity_newbie");if(e.topGenres.length>0)switch(e.topGenres[0].name){case"Aksiyon":return s("identity_action_lover");case"Bilim-Kurgu":return s("identity_sci_fi_explorer");case"Komedi":return s("identity_comedy_fan");case"Dram":return s("identity_dramatic_soul");default:return s("identity_eclectic_taste")}return s("identity_diverse_taste")}function di(e){if(!e||e.length===0)return{totalMovies:0,avgRating:0,watchedThisYear:0,topRatedMovie:null,totalWatchTime:"0 dakika",topGenres:[],topDirectors:[],ratingDistribution:{},cinematicIdentity:s("identity_awaiting_discovery"),timeCapsule:null,badges:{all:Te,earned:[]}};let t=0,a=0,n=null,i=0,o=0,l=0,r=0,u=0,d=0,f=0,c=!1,m=!1,h=0,g=0,v=0,y=0,M=0,w=0;const x={},b={},A={},Y={},ae={},R=[...e].sort((p,_)=>new Date(p.watchedDate)-new Date(_.watchedDate));R.forEach(p=>{var C;p.rating&&p.rating>0&&(t+=parseFloat(p.rating),a++,(!n||p.rating>n.rating)&&(n=p),A[p.rating.toString()]=(A[p.rating.toString()]||0)+1,p.rating===5?(r++,d++):(d>f&&(f=d),d=0),p.rating<=1&&u++),p.comment&&p.comment.trim()!==""&&l++,typeof p.runtime=="number"&&p.runtime>0&&(i+=p.runtime,p.runtime<60&&o++,p.runtime>=180&&(c=!0),p.runtime>=240&&(m=!0));const _=((C=p.genres)==null?void 0:C.map(S=>S.name))||[];if(_.forEach(S=>x[S]=(x[S]||0)+1),p.director&&p.director!=="Bilinmiyor"&&(b[p.director]=(b[p.director]||0)+1),_.includes("Animasyon")&&M++,_.includes("Belgesel")&&w++,p.watchedDate){const S=new Date(p.watchedDate),ye=S.toLocaleString("tr-TR",{month:"long",year:"numeric"});Y[ye]=(Y[ye]||0)+1;const re=S.toDateString();ae[re]=(ae[re]||0)+1;const $=p.release_date?parseInt(p.release_date.substring(0,4),10):0;$>=1980&&$<=1989?h++:$>=1990&&$<=1999?g++:$>=2e3&&$<=2009?v++:$<1970&&y++}}),d>f&&(f=d);let rt=0;const Qt=new Set;Object.keys(ae).forEach(p=>{const _=new Date(p),C=_.getDay();if(C===0||C===5||C===6){const S=new Date(_);S.setDate(S.getDate()-(C===0?-5:C-5));const ye=S.toDateString();if(!Qt.has(ye)){let re=0;for(let $=0;$<3;$++){const Xt=new Date(S);Xt.setDate(S.getDate()+$),re+=ae[Xt.toDateString()]||0}re>rt&&(rt=re),Qt.add(ye)}}});const ta={totalMovies:e.length,totalRuntimeMinutes:i,shortFilmCount:o,hasMarathonMovie:c,hasEpicMovie:m,maxFilmsFromSingleDirector:Math.max(0,...Object.values(b)),maxFilmsInSingleGenre:Math.max(0,...Object.values(x)),uniqueGenreCount:Object.keys(x).length,count80sFilms:h,count90sFilms:g,count00sFilms:v,countPre70sFilms:y,commentedMoviesCount:l,fiveStarCount:r,oneStarCount:u,perfectStreakCount:f,animationCount:M,documentaryCount:w,maxMoviesInDay:Math.max(0,...Object.values(ae)),maxMoviesInWeekend:rt,accountAgeInDays:(new Date-new Date(R[0].watchedDate))/(1e3*60*60*24)},na=Xa(ta),Zt=Object.entries(x).sort(([,p],[,_])=>_-p).slice(0,3).map(([p,_])=>({name:p,count:_})),aa={onThisDay:R.find(p=>{const _=new Date(p.watchedDate),C=new Date;return _.getDate()===C.getDate()&&_.getMonth()===C.getMonth()&&_.getFullYear()<C.getFullYear()}),firstLogged:R[0]||null,firstFiveStar:R.find(p=>p.rating===5)||null,mostWatchedMonth:Object.entries(Y).sort(([,p],[,_])=>_-p)[0]?{month:Object.entries(Y).sort(([,p],[,_])=>_-p)[0][0],count:Object.entries(Y).sort(([,p],[,_])=>_-p)[0][1]}:null};return{totalMovies:e.length,avgRating:a>0?t/a:0,watchedThisYear:R.filter(p=>new Date(p.watchedDate).getFullYear()===new Date().getFullYear()).length,topRatedMovie:n,totalWatchTime:li(i),topGenres:Zt,topDirectors:Object.entries(b).sort(([,p],[,_])=>_-p).slice(0,3).map(([p,_])=>({name:p,count:_})),ratingDistribution:A,cinematicIdentity:ci({totalMovies:e.length,topGenres:Zt}),timeCapsule:aa,badges:{all:Te,earned:na}}}const mi={28:"genre_Action",12:"genre_Adventure",16:"genre_Animation",35:"genre_Comedy",80:"genre_Crime",99:"genre_Documentary",18:"genre_Drama",10751:"genre_Family",14:"genre_Fantasy",36:"genre_History",27:"genre_Horror",10402:"genre_Music",9648:"genre_Mystery",10749:"genre_Romance",878:"genre_Science_Fiction",10770:"genre_TV_Movie",53:"genre_Thriller",10752:"genre_War",37:"genre_Western"};let D,wn,En,Ln,We,qe,Vt,L,k,Me,Pt,Rt;function ui(e){if(D=document.getElementById("filter-modal-overlay"),wn=document.getElementById("apply-filter-btn"),En=document.getElementById("clear-filter-btn"),Ln=document.getElementById("close-filter-modal-button"),L=document.getElementById("rating-slider-min"),k=document.getElementById("rating-slider-max"),Me=document.getElementById("slider-progress"),Pt=document.getElementById("rating-min-value"),Rt=document.getElementById("rating-max-value"),!D||!L)return;Vt=e,wn.addEventListener("click",hi),En.addEventListener("click",fi),Ln.addEventListener("click",nt),D.addEventListener("click",a=>{a.target===D&&nt()});function t(){const a=parseFloat(L.value),n=parseFloat(k.value);Pt.textContent=a.toFixed(1),Rt.textContent=n.toFixed(1);const i=(a-L.min)/(L.max-L.min)*100,o=(n-k.min)/(k.max-k.min)*100;Me.style.left=`${i}%`,Me.style.right=`${100-o}%`}L.addEventListener("input",()=>{parseFloat(L.value)>parseFloat(k.value)&&(L.value=k.value),t()}),k.addEventListener("input",()=>{parseFloat(k.value)<parseFloat(L.value)&&(k.value=L.value),t()})}function gi(e,t){D&&(pi(e,t),D.classList.remove("hidden"),setTimeout(()=>D.classList.add("visible"),10))}function nt(){D&&(D.classList.remove("visible"),D.addEventListener("transitionend",()=>{D.classList.contains("visible")||D.classList.add("hidden")},{once:!0}))}function pi(e,t){const a=new Map;let n=new Date().getFullYear(),i=1900;e.forEach(c=>{var h;(h=c.genres)==null||h.forEach(g=>a.set(g.id,g.name));const m=c.release_date?parseInt(c.release_date.substring(0,4)):0;m&&(m<n&&(n=m),m>i&&(i=m))});const o=document.getElementById("genre-filter-container");o.innerHTML="",[...a.entries()].sort((c,m)=>c[0]-m[0]).forEach(([c,m])=>{var y;const h=(y=t.genres)!=null&&y.includes(m)?"checked":"",g=mi[c]||`genre_${m.replace(/[\s-]/g,"_")}`,v=s(g);o.innerHTML+=`<label class="genre-filter-label"><input type="checkbox" name="genre" value="${m}" ${h}><span>${v}</span></label>`});const r=t.ratingRange?t.ratingRange[0]:1,u=t.ratingRange?t.ratingRange[1]:5;L.value=r,k.value=u,Pt.textContent=parseFloat(r).toFixed(1),Rt.textContent=parseFloat(u).toFixed(1);const d=(r-L.min)/(L.max-L.min)*100,f=(u-k.min)/(k.max-k.min)*100;Me.style.left=`${d}%`,Me.style.right=`${100-f}%`,We=document.getElementById("year-start-input"),qe=document.getElementById("year-end-input"),We.placeholder=n,qe.placeholder=i,We.value=t.yearRange&&t.yearRange[0]||"",qe.value=t.yearRange&&t.yearRange[1]||""}function hi(){const e=[...document.querySelectorAll("#genre-filter-container input:checked")].map(i=>i.value),t=[parseFloat(L.value),parseFloat(k.value)],a=[parseInt(We.value,10)||null,parseInt(qe.value,10)||null],n={};e.length>0&&(n.genres=e),(t[0]>1||t[1]<5)&&(n.ratingRange=t),(a[0]||a[1])&&(n.yearRange=a),Vt(n),nt()}function fi(){Vt({}),nt()}function vi(e,t){return e.filter(a=>{var n;if(t.genres&&t.genres.length>0){const i=((n=a.genres)==null?void 0:n.map(o=>o.name))||[];if(!t.genres.some(o=>i.includes(o)))return!1}if(t.ratingRange&&(!a.rating||a.rating<t.ratingRange[0]||a.rating>t.ratingRange[1]))return!1;if(t.yearRange){const i=a.release_date?parseInt(a.release_date.substring(0,4)):0;if(!i||t.yearRange[0]&&i<t.yearRange[0]||t.yearRange[1]&&i>t.yearRange[1])return!1}return!0})}const yi=[{id:"top_rated_all_time",name:"list_top_rated_all_time_name",description:"list_top_rated_all_time_desc",type:"endpoint",tmdbId:"/movie/top_rated"},{id:"harry_potter_collection",name:"list_harry_potter_collection_name",description:"list_harry_potter_collection_desc",type:"collection",tmdbId:"1241"},{id:"oscars_2024_winners",name:"list_oscars_2024_winners_name",description:"list_oscars_2024_winners_desc",type:"manual",tmdbId:[872585,792307,915935,840430,467244,363215,508883]},{id:"christopher_nolan_films",name:"list_christopher_nolan_films_name",description:"list_christopher_nolan_films_desc",type:"director",tmdbId:"525"},{id:"ghibli_magic",name:"list_ghibli_magic_name",description:"list_ghibli_magic_desc",type:"endpoint",tmdbId:"/discover/movie?with_companies=10342&sort_by=vote_average.desc"},{id:"action_packed_adrenaline",name:"list_action_packed_adrenaline_name",description:"list_action_packed_adrenaline_desc",type:"endpoint",tmdbId:"/discover/movie?with_genres=28&sort_by=popularity.desc&primary_release_date.gte=2015-01-01"},{id:"mcu_phase_one",name:"list_mcu_phase_one_name",description:"list_mcu_phase_one_desc",type:"collection",tmdbId:"86311"},{id:"quentin_tarantino_films",name:"list_quentin_tarantino_films_name",description:"list_quentin_tarantino_films_desc",type:"director",tmdbId:"138"},{id:"lord_of_the_rings_trilogy",name:"list_lord_of_the_rings_trilogy_name",description:"list_lord_of_the_rings_trilogy_desc",type:"collection",tmdbId:"119"}];function _i(){return yi}const Yn=document.getElementById("my-watched-movies-section"),bi=document.getElementById("my-movies-list"),wi=document.getElementById("my-movies-empty-message"),V=document.getElementById("sort-button"),ce=document.getElementById("sort-options-menu"),In=document.querySelectorAll(".sort-option"),Ft=document.getElementById("filter-button"),Ei=document.getElementById("trending-movies-section"),Li=document.getElementById("trending-movies-grid"),_e=document.getElementById("trending-error-message"),Ii=document.getElementById("special-lists-section"),zn=document.getElementById("list-detail-section"),je=document.getElementById("list-detail-title"),kn=document.getElementById("list-detail-grid"),Vn=document.getElementById("watch-later-movies-section"),Kn=document.getElementById("watch-later-movies-list"),Jn=document.getElementById("watch-later-empty-message"),ki=document.getElementById("profile-section"),Bn=document.getElementById("profile-logged-in-view"),Mn=document.getElementById("profile-logged-out-view"),xn=document.getElementById("add-movie-float-button");document.getElementById("special-lists-loader");const Ue=document.getElementById("special-lists-content-container");let Qn="date-desc",Ye={};function De(e){if(Yn.classList.contains("hidden"))return;e!==void 0&&(Ye=e),Ft.classList.toggle("active",Object.keys(Ye).length>0);const a=[...vi(ve,Ye)];switch(Qn){case"date-desc":a.sort((i,o)=>new Date(o.watchedDate)-new Date(i.watchedDate));break;case"date-asc":a.sort((i,o)=>new Date(i.watchedDate)-new Date(o.watchedDate));break;case"rating-desc":a.sort((i,o)=>(o.rating||0)-(i.rating||0));break;case"rating-asc":a.sort((i,o)=>(i.rating||0)-(o.rating||0));break;case"title-asc":a.sort((i,o)=>i.title.localeCompare(o.title));break}ni(bi,a,wi,$e);const n=ce.querySelector(".sort-option.active");n&&(V.querySelector("span").textContent=`${s("sort_button_prefix")} ${s(n.dataset.i18n)}`)}function Zn(){Vn.classList.contains("hidden")||qn(Kn,Pe,Jn,$e)}function Bi(){!V||!ce||!Ft||(ui(De),V.addEventListener("click",e=>{e.stopPropagation(),ce.classList.toggle("hidden"),V.classList.toggle("open")}),In.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),In.forEach(a=>a.classList.remove("active")),e.classList.add("active"),Qn=e.dataset.sort,V.querySelector("span").textContent=`${s("sort_button_prefix")} ${s(e.dataset.i18n)}`,ce.classList.add("hidden"),V.classList.remove("open"),De()})}),Ft.addEventListener("click",()=>{gi(ve,Ye)}),document.addEventListener("click",e=>{!V.contains(e.target)&&!ce.classList.contains("hidden")&&(ce.classList.add("hidden"),V.classList.remove("open"))}))}function ze(e){if(e&&!e.isAnonymous){Mn.classList.add("hidden"),Bn.classList.remove("hidden"),document.getElementById("profile-name").textContent=e.email.split("@")[0],document.getElementById("profile-email").textContent=e.email;const t=di(ve);oi(t)}else Bn.classList.add("hidden"),Mn.classList.remove("hidden")}async function Mi(e){document.querySelectorAll(".content-section").forEach(t=>t.classList.add("hidden")),zn.classList.remove("hidden"),je.textContent=s("loading"),Ce("Liste detayları getiriliyor...");try{const t=await Rn(e);console.log(`'${e.name}' anahtarı için çeviri deneniyor...`),je.dataset.i18n=e.name,je.textContent=s(e.name),ri(kn,t,zt)}catch{je.textContent="Hata",kn.innerHTML=`<p class="text-red-400 text-center col-span-full">${s("list_load_error")}</p>`}finally{fe()}}async function J(e){const t=[Ei,Yn,Vn,ki,Ii,zn],a=document.querySelectorAll(".nav-item");if(t.forEach(n=>{n.classList.toggle("hidden",n.id!==e)}),a.forEach(n=>{let i="";e==="my-watched-movies-section"?i="nav-my-log":e==="trending-movies-section"?i="nav-trending":e==="special-lists-section"?i="nav-lists":e==="watch-later-movies-section"?i="nav-watch-later":e==="profile-section"&&(i="nav-profile"),n.classList.toggle("active",n.id===i)}),e==="my-watched-movies-section"||e==="watch-later-movies-section"?xn.style.display="flex":xn.style.display="none",_e.style.display="none",e==="my-watched-movies-section")De();else if(e==="trending-movies-section"){Ce(),Li.innerHTML="";const n=new Promise(o=>setTimeout(o,1300)),i=Fa();try{const[o,l]=await Promise.all([n,i]);l.length===0?(_e.textContent=s("trending_no_movies_found"),_e.style.display="block"):ai(l,zt)}catch(o){_e.textContent=s("trending_error").replace("{error}",o.message),_e.style.display="block"}finally{fe()}}else if(e==="special-lists-section"){Ce(),Ue.innerHTML="",Ue.classList.add("hidden");const n=new Promise(r=>setTimeout(r,1300)),i=(async()=>{const r=_i(),u=r.map(f=>Rn(f)),d=await Promise.all(u);return r.map((f,c)=>{const m=d[c].find(h=>h.poster_path);return{...f,heroImage:m?`https://image.tmdb.org/t/p/w500${m.poster_path}`:null}})})(),[o,l]=await Promise.all([n,i]);fe(),Ue.classList.remove("hidden"),si(Ue,l,Mi)}else e==="watch-later-movies-section"?qn(Kn,Pe,Jn,$e):e==="profile-section"&&ze(U.currentUser)}document.getElementById("back-to-lists-btn").addEventListener("click",()=>{J("special-lists-section")});let ve=[],Pe=[],Ht=null,Ot=null;function Xn(){Ht&&Ht(),Ot&&Ot()}function xi(e){return new Promise((t,a)=>{Xn();let n=!1,i=!1;const o=()=>{n&&i&&(console.log("Initial data from both collections loaded."),t())},l=en(xe,"users",e,"watchedMovies");Ht=tn(l,u=>{ve=u.docs.map(d=>({id:d.id,...d.data()})),De(),n||(n=!0,o())},u=>{console.error("Watched movies listener error:",u),a(u)});const r=en(xe,"users",e,"watchLaterMovies");Ot=tn(r,u=>{Pe=u.docs.map(d=>({id:d.id,...d.data()})),Zn(),i||(i=!0,o())},u=>{console.error("Watch later listener error:",u),a(u)})})}function Ai(){Xn(),ve=[],Pe=[],console.log("Local movie lists cleared.")}async function Si(e){var r;const t=(r=U.currentUser)==null?void 0:r.uid;if(!t)return console.error("User not authenticated to save movie.");const{id:a,type:n,...i}=e,o=n==="watched"?"watchedMovies":"watchLaterMovies";if(!a)return console.error("Movie ID is missing. Cannot save movie.");const l=Wt(xe,"users",t,o,a);try{await ra(l,i,{merge:!0}),console.log(`Movie ${a} saved to ${o}`)}catch(u){console.error("Error saving movie: ",u)}}async function Ci(e,t){var o;const a=(o=U.currentUser)==null?void 0:o.uid;if(!a)return console.error("User not authenticated to delete movie.");if(!e||!t)return console.error("Movie ID or list type is missing.");const n=t==="watched"?"watchedMovies":"watchLaterMovies",i=Wt(xe,"users",a,n,e);try{await sa(i),console.log(`Movie ${e} deleted from ${n}`)}catch(l){console.error("Error deleting movie: ",l)}}function Ti(){var n,i,o,l,r,u,d,f;(n=document.getElementById("nav-my-log"))==null||n.addEventListener("click",()=>J("my-watched-movies-section")),(i=document.getElementById("nav-trending"))==null||i.addEventListener("click",()=>J("trending-movies-section")),(o=document.getElementById("nav-lists"))==null||o.addEventListener("click",()=>J("special-lists-section")),(l=document.getElementById("nav-watch-later"))==null||l.addEventListener("click",()=>J("watch-later-movies-section")),(r=document.getElementById("nav-profile"))==null||r.addEventListener("click",()=>J("profile-section")),(u=document.getElementById("add-movie-float-button"))==null||u.addEventListener("click",()=>$e()),(d=document.getElementById("sign-out-button"))==null||d.addEventListener("click",Da);const e=document.getElementById("movie-details-modal-overlay");(f=document.getElementById("close-detail-modal-button"))==null||f.addEventListener("click",()=>$t()),e&&e.addEventListener("click",c=>{c.target===e&&$t()});const t=document.getElementById("email-auth-form");if(t){const c=document.getElementById("auth-tab-login"),m=document.getElementById("auth-tab-signup"),h=document.getElementById("auth-submit-button"),g=document.getElementById("auth-error-message"),v=document.getElementById("auth-email");document.getElementById("auth-email-error");const y=document.getElementById("auth-password"),M=document.getElementById("auth-password-toggle"),w=document.getElementById("eye-open-icon"),x=document.getElementById("eye-closed-icon");c&&c.addEventListener("click",()=>{c.classList.add("active"),m.classList.remove("active"),h.textContent=s("auth_submit_login"),g.classList.add("hidden")}),m&&m.addEventListener("click",()=>{m.classList.add("active"),c.classList.remove("active"),h.textContent=s("auth_submit_signup"),g.classList.add("hidden")}),M&&M.addEventListener("click",()=>{const b=y.type==="password";y.type=b?"text":"password",w==null||w.classList.toggle("hidden",b),x==null||x.classList.toggle("hidden",!b)}),t.addEventListener("submit",async b=>{b.preventDefault();const A=v.value,Y=y.value,ae=c.classList.contains("active");g.classList.add("hidden"),h.disabled=!0;try{if(ae)await Ta(A,Y),te(s("notification_login_success"),"success");else{const R=await Ca(A,Y);te(s("notification_signup_success"),"success"),t.reset()}}catch(R){console.error("Authentication Error:",R),g.textContent=Di(R),g.classList.remove("hidden")}finally{h.disabled=!1}})}const a=document.querySelectorAll(".plan-option");a.forEach(c=>{c.addEventListener("click",()=>{a.forEach(m=>{m.classList.remove("selected")}),c.classList.add("selected")})})}function Di(e){switch(e.code){case"auth/invalid-email":return s("auth_error_invalid_email");case"auth/user-not-found":case"auth/wrong-password":case"auth/invalid-credential":return s("auth_error_wrong_password");case"auth/email-already-in-use":return s("auth_error_email_in_use");case"auth/weak-password":return s("auth_error_weak_password");default:return s("auth_error_default")}}let bt,O,An,Kt,Sn,N,j,Cn,Nt,Tn,Jt="";function $i(){if(bt=document.getElementById("suggestMovieBtn"),O=document.getElementById("promptModalOverlay"),An=document.getElementById("closePromptModalBtn"),Kt=document.getElementById("moviePromptInput"),Sn=document.getElementById("submitPromptBtn"),N=document.getElementById("promptError"),j=document.getElementById("suggestionResultOverlay"),Cn=document.getElementById("closeSuggestionResultBtn"),Nt=document.getElementById("suggestionGrid"),Tn=document.getElementById("tryAgainBtn"),!bt||!O||!j){console.error("Film öneri DOM elementlerinden bazıları bulunamadı.");return}bt.addEventListener("click",()=>{Ke()?jt():It()}),An.addEventListener("click",Ut),O.addEventListener("click",e=>{e.target===O&&Ut()}),Sn.addEventListener("click",Hi),Cn.addEventListener("click",Gt),j.addEventListener("click",e=>{e.target===j&&Gt()}),Tn.addEventListener("click",Fi)}function jt(){at(),Kt.value="",N.textContent="",N.classList.add("hidden"),O.classList.remove("hidden"),setTimeout(()=>O.classList.add("visible"),10)}function Ut(){it(),O.classList.remove("visible"),setTimeout(()=>{document.querySelector(".modal-overlay.visible")},100),O.addEventListener("transitionend",()=>{O.classList.contains("visible")||O.classList.add("hidden")},{once:!0})}function Pi(e){at(),Ri(e),j.classList.remove("hidden"),setTimeout(()=>j.classList.add("visible"),10)}function Gt(){it(),j.classList.remove("visible"),setTimeout(()=>{document.querySelector(".modal-overlay.visible")},100),j.addEventListener("transitionend",()=>{j.classList.contains("visible")||j.classList.add("hidden")},{once:!0})}function Ri(e){Nt.innerHTML="",e.slice(0,4).forEach(t=>{if(!t||!t.id)return;const a=document.createElement("div");a.className="suggestion-poster-item";const n=document.createElement("img");n.src=t.poster_path?`https://image.tmdb.org/t/p/w500${t.poster_path}`:"https://placehold.co/400x600/2A2A2A/AAAAAA?text=Poster+Yok",n.alt=t.title,n.onerror=function(){this.onerror=null,this.src="https://placehold.co/400x600/2A2A2A/AAAAAA?text=Poster+Yok"},a.appendChild(n),a.addEventListener("click",()=>{zt(t.id,!0)}),Nt.appendChild(a)})}async function Fi(){Jt&&(Gt(),await ea(!0))}async function Hi(){const e=Kt.value.trim();if(!e){N.textContent="Lütfen bir film öneri isteği girin.",N.classList.remove("hidden");return}Jt=e,N.classList.add("hidden"),Ut(),await ea()}async function ea(e=!1){const t=s(e?"ai_loading_retry":"ai_loading_initial");Ce(t);try{const a=await Oa(Jt,e);if(fe(),a&&a.movies&&a.movies.length>0)Pi(a.movies);else{const n=a.error||"İsteğine uygun filmler bulunamadı. Lütfen daha farklı bir dilde veya içerikte tekrar dene.";jt(),N.textContent=n,N.classList.remove("hidden")}}catch(a){fe(),console.error("Film önerisi alınırken hata:",a),jt(),N.textContent=`Bir hata oluştu: ${a.message}`,N.classList.remove("hidden")}}let wt=null;function Oi(){const e=document.getElementById("splash-screen");if(!e)return;const t=document.createElement("div");t.id="splash-background-grid";const a=["https://image.tmdb.org/t/p/w500/pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg","https://image.tmdb.org/t/p/w500/vseIVRdN4xasYwStQIi6SI7DcEu.jpg","https://image.tmdb.org/t/p/w500/qJ2tW6WMUDux911r6m7haRef0WH.jpg","https://image.tmdb.org/t/p/w500/AgY33Wtg4737MhYopJSFyKWhKsO.jpg","https://image.tmdb.org/t/p/w500/2rNjLWhb9hjv2ZmKAZVItjuJsCP.jpg","https://image.tmdb.org/t/p/w500/8g1aqEKt80x1gbKqc8a1TWb9cr6.jpg","https://image.tmdb.org/t/p/w500/4KAtscEx3Pt9YPpNuK3BO6irQn1.jpg","https://image.tmdb.org/t/p/w500/cVeJ2kQ9qZmpud57iSKsANyAsNp.jpg","https://image.tmdb.org/t/p/w500/hEntfzxB8yUXIxqZY929dELjLsi.jpg","https://image.tmdb.org/t/p/w500/6oom5QYQ2yQTMJIbnvbkBL9cHo6.jpg","https://image.tmdb.org/t/p/w500/46oFAcjORMltwPxR6uU6hM4mN7F.jpg","https://image.tmdb.org/t/p/w500/yh5rAnhNiZz0nkWhbWw98MvdvBH.jpg"];[...a,...a].forEach(i=>{const o=document.createElement("div");o.className="splash-poster",o.style.backgroundImage=`url(${i})`,t.appendChild(o)}),e.prepend(t)}function Ni(){const e=document.getElementById("splash-screen"),t=document.getElementById("main-container");t.classList.contains("hidden")&&(console.log("UI is not visible, showing it now..."),t.classList.remove("hidden"),J("my-watched-movies-section"),e.classList.add("fade-out"),e.addEventListener("transitionend",()=>e.style.display="none",{once:!0}))}async function ji(){Ba(),await La(),Ma(),console.log("initializeApp: Starting application..."),Oi(),Ti(),Bi(),ei(),Nn(),$i(),wa();let e=!1;Aa(async t=>{if(t){if(t.uid!==wt){wt=t.uid,Ce("Verileriniz yükleniyor...");try{await Promise.all([xi(t.uid),nn(t.uid)]),Lt()}catch(a){console.error("Firestore'dan ilk veri yüklenirken hata oluştu:",a)}finally{fe()}}e||(Ni(),e=!0),ze(t)}else console.log("Auth state changed. No user found. Signing in anonymously..."),Ai(),await nn(null),Lt(),ze(null),wt=null,Sa().catch(a=>{})}),document.addEventListener("language-changed",()=>{const t=document.querySelector(".content-section:not(.hidden)");if(t)switch(console.log(`Dil değişti, aktif bölüm yenileniyor: ${t.id}`),t.id){case"profile-section":ze(U.currentUser);break;case"my-watched-movies-section":De();break;case"watch-later-movies-section":Zn();break;default:J(t.id);break}})}document.addEventListener("DOMContentLoaded",()=>ji());
